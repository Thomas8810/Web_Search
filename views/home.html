<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Web Tra Cứu - Nguyễn Văn Đạo</title>
<!-- CSS Select2 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
<!-- Thêm i18next và i18next-browser-languagedetector -->
<script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
<script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
<style>
    /* Cài đặt CSS cơ bản */
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: url('background.jpg') no-repeat center center/cover;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .page-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .top-container {
      flex: 0 0 auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 15px;
      max-height: 40vh;
      overflow-y: auto;
      position: relative;
    }
    .header {
      text-align: center;
      padding: 10px;
      position: relative;
    }
    .tasks-link {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #fff;
  background: #007bff;
  padding: 5px 10px;
  border-radius: 4px;
  text-decoration: none;
  font-weight: bold;
  transition: background 0.3s;
}
.tasks-link:hover {
  background: #0056b3;
}
    .header h1 { margin: 0; font-size: 28px; color: white; }
    .header p { margin: 5px 0 0; font-size: 16px; color: #ddd; }
    /* Language switcher ở góc trên bên phải */
    .language-switcher {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .language-switcher button {
      padding: 4px 8px;
      margin-left: 5px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      border-radius: 3px;
      background: #ff8c00;
      color: white;
      transition: background 0.3s;
    }
    .language-switcher button:hover {
      background: #ff6500;
    }
    /* Khối chứa các tiêu chí lọc */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 5px;
    }
    .filter-block {
      background: #444;
      border-radius: 5px;
      padding: 5px;
      margin: 5px;
      width: 180px;
      font-size: 12px;
      color: white;
    }
    .filter-block label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }
    .filter-block select {
      width: 100%;
      padding: 3px;
      margin-bottom: 3px;
      font-size: 12px;
    }
    /* Khối chứa các nút chức năng */
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 5px;
    }
    .action-bar > div {
      background: #444;
      border-radius: 5px;
      padding: 5px;
      margin: 5px;
      font-size: 12px;
      color: white;
      text-align: center;
    }
    .action-bar button {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.3s;
      margin: 3px;
    }
    .filter-actions button {
      background: linear-gradient(45deg, #ff8c00, #ff4500);
      color: white;
    }
    .filter-actions button:hover {
      background: linear-gradient(45deg, #ff6500, #ff0000);
    }
    .download-container button {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
    }
    .download-container button:hover {
      background: linear-gradient(45deg, #3399ff, #007bff);
    }
    .zoom-controls button {
      background: linear-gradient(45deg, #28a745, #218838);
      color: white;
    }
    .zoom-controls button:hover {
      background: linear-gradient(45deg, #34d058, #28a745);
    }
    /* Phần hiển thị tổng số dòng */
    .results-count {
      text-align: center;
      margin: 5px;
      font-size: 14px;
      color: white;
    }
    /* Bảng dữ liệu */
    .table-container {
      flex: 1 1 auto;
      margin: 5px auto;
      width: 98%;
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      overflow-x: auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    table {
      width: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      padding: 6px 8px;
      border: 1px solid #ccc;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #4a76a8;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .sticky-col-1 {
      position: sticky;
      left: 0;
      width: 40px;
      min-width: 40px;
      background: #4a76a8;
      z-index: 3;
    }
    .sticky-col-2 {
      position: sticky;
      left: 40px;
      width: 100px;
      min-width: 100px;
      background: #4a76a8;
      z-index: 3;
    }
    .sticky-col-3 {
      position: sticky;
      left: 140px;
      width: 50px;
      min-width: 50px;
      background: #4a76a8;
      z-index: 3;
    }
    td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
      background: #e6e6e6;
      color: #333;
      z-index: 1;
    }
    tr.selected { background-color: #ffeb99 !important; }
    .footer {
      flex: 0 0 auto;
      text-align: center;
      padding: 5px;
      font-size: 14px;
      background: #333;
      color: white;
    }
    @media (max-width: 768px) {
  /* Đưa language switcher xuống dưới tiêu đề */
  .language-switcher {
    position: static;
    margin-top: 10px;
    text-align: center;
  }
  .language-switcher button {
    padding: 3px 6px;
    margin: 0 3px;
    font-size: 10px;
  }

  /* Giảm khoảng cách và kích thước nút chức năng */
  .action-bar {
    justify-content: center;
    padding: 3px;
  }
  .action-bar > div {
    margin: 3px auto;
    padding: 3px;
    font-size: 14px;
  }
  .action-bar button {
    padding: 4px 8px;
    margin: 2px;
    font-size: 14px;
  }
}

    @media (max-width: 768px) {
      .filter-bar, .action-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-block, .action-bar > div {
        width: 90%;
        margin: 5px auto;
      }
      .header h1 { font-size: 24px; }
      .header p { font-size: 14px; }
      table, th, td { font-size: 10px; }
      .table-container {
        max-height: calc(100vh - 320px);
      }
    }
    @media (max-width: 480px) {
      .tasks-link {
    position: relative;
    top: 0;
    left: 0;
    display: block;
    width: 100%;
    text-align: center;
    padding: 10px 0;
    font-size: 16px;
  }
      .header h1 { font-size: 20px; }
      .header p { font-size: 12px; }
      table, th, td { font-size: 9px; }
    }
  
@media (max-width: 768px) {
  body {
    padding-bottom: 300px; /* chừa chỗ cho bàn phím */
  }
}

@media screen and (orientation: landscape), (orientation: portrait) {
  .table-container {
    max-height: 60vh;
    overflow-y: auto;
    overflow-x: auto;
    touch-action: pan-y;
  }

  table {
    width: auto;
    min-width: 100%;
  }

  td, th {
    word-break: break-word;
  }
}

/* Tối ưu bảng cho điện thoại xoay ngang/dọc và khi mở bàn phím */
.table-container {
  width: 100vw;
  max-height: 50vh;
  overflow-x: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  touch-action: auto;
}

@media screen and (orientation: landscape) {
  .table-container {
    max-height: 60vh;
  }
}

@media screen and (orientation: portrait) {
  .table-container {
    max-height: 50vh;
  }
}

table {
  min-width: 800px;
}

th, td {
  word-break: break-word;
  white-space: nowrap;
}

.table-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  max-height: 60vh;
  -webkit-overflow-scrolling: touch;
}
table {
  border-collapse: collapse;
  min-width: 1000px;
}
th, td {
  white-space: nowrap;
  padding: 6px;
  font-size: 12px;
}
.sticky-col-1 {
  position: sticky; left: 0; background: #4a76a8; z-index: 3;
}
.sticky-col-2 {
  position: sticky; left: 40px; background: #4a76a8; z-index: 3;
}
.sticky-col-3 {
  position: sticky; left: 140px; background: #4a76a8; z-index: 3;
}
td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
  background: #f3f3f3;
}

/* --- Cải tiến cho input khi focus --- */
input:focus, select:focus {
  outline: 2px solid #ff8c00;
  background-color: #fffce6;
}

/* Tăng font input trên điện thoại để dễ nhập */
@media (max-width: 768px) {
  input, select {
    font-size: 16px;
  }
}

/* Cải thiện bảng khi xoay ngang */
@media screen and (orientation: landscape) {
  .top-container {
    max-height: 30vh;
    overflow-y: auto;
  }
  .table-container {
    height: auto;
    max-height: 90vh;
    min-height: 70vh;
    overflow-x: auto;
    overflow-y: auto;
  }
  table {
    min-width: 1200px;
  }
}

</style>
</head>
<body>
<div class="page-container">
<div class="top-container">
<div class="header">
<a class="tasks-link" href="/tasks">Tasks</a>
<h1 id="header-title">FAIR TEAM - Tra cứu tình trạng FAIR</h1>
<p id="header-subtitle">Tra cứu tình trạng FAIR</p>
<!-- Nút chuyển đổi ngôn ngữ ở góc trên bên phải -->
<div class="language-switcher">
<button onclick="changeLanguage('vi')">Vi</button>
<button onclick="changeLanguage('en')">En</button>
<button onclick="changeLanguage('ko')">Ko</button>
</div>
</div>

<!-- Phần tiêu chí lọc -->
<div class="filter-bar">
  <!-- Filter Block 0: Customer -->
  <div class="filter-block" id="filter-block-0">
    <label for="filter-value-0" id="label-filter-customer">Chọn Customer</label>
    <select class="value-select" id="filter-value-0" multiple="multiple"></select>
  </div>
  <!-- Filter Block 1 -->
  <div class="filter-block" id="filter-block-1">
    <label for="filter-column-1" id="label-criteria-1">Chọn tiêu chí số 1:</label>
    <select id="filter-column-1"></select>
    <label for="filter-value-1" id="label-filter-value-1">Chọn giá trị</label>
    <select class="value-select" id="filter-value-1" multiple="multiple"></select>
  </div>
  <!-- Filter Block 2 -->
  <div class="filter-block" id="filter-block-2">
    <label for="filter-column-2" id="label-criteria-2">Chọn tiêu chí số 2:</label>
    <select id="filter-column-2"></select>
    <label for="filter-value-2" id="label-filter-value-2">Chọn giá trị</label>
    <select class="value-select" id="filter-value-2" multiple="multiple"></select>
  </div>
  <!-- Filter Block 3 -->
  <div class="filter-block" id="filter-block-3">
    <label for="filter-column-3" id="label-criteria-3">Chọn tiêu chí số 3:</label>
    <select id="filter-column-3"></select>
    <label for="filter-value-3" id="label-filter-value-3">Chọn giá trị</label>
    <select class="value-select" id="filter-value-3" multiple="multiple"></select>
  </div>
</div>

<!-- Khối chứa các nút chức năng -->
<div class="filter-actions">
<button id="apply-filters">Áp Dụng Lọc</button>
<button id="clear-filters">Xóa Lọc</button>
</div>
<div class="download-container">
<button id="download-excel">Xuất Excel (Đang xem)</button>
<button id="export-all">Xuất Excel (Tất cả)</button>
</div>
<div class="zoom-controls">
<button id="zoom-in">Phóng to</button>
<button id="zoom-out">Thu nhỏ</button>
</div>
</div>
<!-- Phần hiển thị tổng số dòng -->
<div class="scan-camera" style="text-align:center; margin-top:10px;">
<button id="btnScanCamera">📷 Quét Camera</button>
</div>
<div class="results-count" id="results-count">Total rows: 0</div>
</div>
<!-- Khu vực hiển thị bảng dữ liệu -->
<div class="table-container">
<table id="results-table">

<thead><tr>
<th class="sticky-col-1">No</th>
<th class="sticky-col-2">Part Number</th>
<th class="sticky-col-3">REV</th>
<th>Approval Status</th>
<th>Customer</th>
<th>Commodity</th>
<th>Part Pictures</th>
<th>Packaging Pictures</th>
<th>Critical</th>
<th>CE</th>
<th>PO Number</th>
<th>Description</th>
<th>Type</th>
<th>Note Number</th>
<th>PO received date</th>
<th>Customer need date</th>
<th>Requirements</th>
<th>FAIR Cover sheet</th>
<th>Bubble Drawings</th>
<th>Datasheet form</th>
<th>LAIR Data</th>
<th>FAIR Data</th>
<th>COC</th>
<th>BOM</th>
<th>Mill</th>
<th>Test reports / evidences</th>
<th>Production Status</th>
<th>Remark 1</th>
<th>Remark 2</th>
<th>Submit date</th>
<th>Reject comments</th>
</tr></thead>
<tbody>
<!-- Dữ liệu sẽ được load tại đây -->
</tbody>
</table>
</div>
<!-- Nút tải thêm -->
<div id="load-more-container" style="text-align:center; margin:10px;">
<button id="load-more">Load More</button>
<button id="load-all">Load All</button>
</div>
<!-- Footer -->
<div class="footer" id="footer-text">Người phát triển: Nguyễn Văn Đạo</div>
</div>
<!-- JS Thư viện -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>
<!-- i18next Integration -->

<script>
// Populate criteria selects for blocks 1-3
function populateCriteriaSelects() {
  if (!allData || allData.length === 0) {
    setTimeout(populateCriteriaSelects, 100);
    return;
  }
  const headerOrder = Object.keys(allData[0]);
  const criteriaOptions = headerOrder.filter(col => col !== 'Customer');
  [1,2,3].forEach(i => {
    const sel = $(`#filter-column-${i}`);
    sel.empty();
    criteriaOptions.forEach(col => sel.append(new Option(col, col)));
  });
}

// Update distinct values for a block
function updateFilterValuesForBlock(blockIndex) {
  if (!allData) {
    setTimeout(() => updateFilterValuesForBlock(blockIndex), 100);
    return;
  }
  let filtered = allData.slice();
  for (let i = 0; i < blockIndex; i++) {
    const col = (i===0) ? 'Customer' : $(`#filter-column-${i}`).val();
    const vals = $(`#filter-value-${i}`).val();
    if (col && vals && vals.length) {
      filtered = filtered.filter(row =>
        vals.some(v => row[col] && row[col].toString().toLowerCase().includes(v.toLowerCase()))
      );
    }
  }
  const depCol = (blockIndex===0) ? 'Customer' : $(`#filter-column-${blockIndex}`).val();
  const vals = filtered.map(r => r[depCol]|| '').filter(v=>v!=='');
  const distinct = Array.from(new Set(vals.map(v=>v.toString().toUpperCase()))).sort();
  const sel = $(`#filter-value-${blockIndex}`);
  sel.empty();
  distinct.forEach(v=>sel.append(new Option(v, v)));
  sel.trigger('change');
}

// Cascade update
function updateCascade(startBlock) {
  for (let i = startBlock; i <= 3; i++) {
    updateFilterValuesForBlock(i);
  }
}

// Apply filters
function applyFilters(reset = true) {
  if (reset) {
    currentOffset = 0;
    $('#results-table tbody').empty();
  }
  let params = { limit: pageSize, offset: currentOffset };
  for (let i = 0; i <= 3; i++) {
    const col = (i===0) ? 'Customer' : $(`#filter-column-${i}`).val();
    const vals = $(`#filter-value-${i}`).val();
    if (vals && vals.length) {
      params[col] = vals.join(',');
    }
  }
  currentFilters = params;
  const queryString = $.param(params);
  $.getJSON(`/search?${queryString}`, function(response) {
    totalData = response.total;
    currentOffset += pageSize;
    updateTable(response.data, true);
  });
}

// Initialize filters on load
$(document).ready(function() {
  populateCriteriaSelects();
  updateCascade(0);
  // Bind change events
  $('#filter-value-0').on('change', ()=> updateCascade(1));
  [1,2,3].forEach(i => {
    $(`#filter-column-${i}`).on('change', ()=>{ updateFilterValuesForBlock(i); updateCascade(i+1); });
    $(`#filter-value-${i}`).on('change', ()=> updateCascade(i+1));
  });
});
</script>

<script>
// Hàm cập nhật bảng dữ liệu
function updateTable(data, reset) {
  const tbody = $('#results-table tbody');
  if (reset) tbody.empty();
  
  data.forEach(function(row) {
    const serial = tbody.children().length + 1;
    const tr = $('<tr>');

    // Các cột cố định và các cột theo thứ tự đã định
    tr.append(`<td class="sticky-col-1">${serial}</td>`);
    tr.append(`<td class="sticky-col-2">${row['Part Number'] || ''}</td>`);
    tr.append(`<td class="sticky-col-3">${row['REV'] || ''}</td>`);
    tr.append(`<td>${row['Approval Status'] || ''}</td>`);
    tr.append(`<td>${row['Customer'] || ''}</td>`);
    tr.append(`<td>${row['Commodity'] || ''}</td>`);
    tr.append(`<td>${row['Part Pictures'] || ''}</td>`);
    tr.append(`<td>${row['Packaging Pictures'] || ''}</td>`);
    tr.append(`<td>${row['Critical'] || ''}</td>`);
    tr.append(`<td>${row['CE'] || ''}</td>`);
    tr.append(`<td>${row['PO Number'] || ''}</td>`);
    tr.append(`<td>${row['Description'] || ''}</td>`);
    tr.append(`<td>${row['Type'] || ''}</td>`);
    tr.append(`<td>${row['Note Number'] || ''}</td>`);
    tr.append(`<td>${formatExcelDate(row['PO received date'])}</td>`);
    tr.append(`<td>${formatExcelDate(row['Customer need date'])}</td>`);
    tr.append(`<td>${row['Requirements'] || ''}</td>`);
    tr.append(`<td>${row['FAIR Cover sheet'] || ''}</td>`);
    tr.append(`<td>${row['Bubble Drawings'] || ''}</td>`);
    tr.append(`<td>${row['Datasheet form'] || ''}</td>`);
    tr.append(`<td>${row['LAIR Data'] || row['LAIR data'] || ''}</td>`);
    tr.append(`<td>${row['FAIR Data'] || ''}</td>`);
    tr.append(`<td>${row['COC'] || ''}</td>`);
    tr.append(`<td>${row['BOM'] || ''}</td>`);
    tr.append(`<td>${row['Mill'] || ''}</td>`);
    tr.append(`<td>${row['Test reports / evidences'] || ''}</td>`);
    tr.append(`<td>${row['Production Status'] || ''}</td>`);
    tr.append(`<td>${row['Remark 1'] || ''}</td>`);
    tr.append(`<td>${row['Remark 2'] || ''}</td>`);
    tr.append(`<td>${formatExcelDate(row['Submit date'])}</td>`);
    tr.append(`<td>${row['Reject comments'] || ''}</td>`);

    tbody.append(tr);
  });

  var totalText = i18next.t("total_rows", { count: tbody.children().length, total: totalData });
  $('#results-count').text(totalText);

  // Sử dụng colResizable nếu có
  try {
    if (typeof $.fn.colResizable === 'function') {
      $('#results-table').colResizable({ liveDrag: true });
    }
  } catch (e) {
    console.log("colResizable not available in updateTable:", e);
  }
}

    // Hàm xuất Excel
    function downloadExcel() {
      var wb = XLSX.utils.table_to_book(document.getElementById('results-table'), {sheet:"Sheet1"});
      XLSX.writeFile(wb, 'ketqua.xlsx');
    }

    // Hàm sắp xếp bảng khi click tiêu đề cột
    function getColumnIndex(columnName) {
      let index = -1;
      $('#results-table th').each(function(i) {
        if ($(this).data('column') === columnName) {
          index = i;
          return false;
        }
      });
      return index;
    }
    function sortTable(column, order) {
      let rows = $('#results-table tbody tr').get();
      let colIndex = getColumnIndex(column);
      if (colIndex === -1) return;
      rows.sort(function(a, b) {
        let A = $(a).children('td').eq(colIndex).text().toUpperCase();
        let B = $(b).children('td').eq(colIndex).text().toUpperCase();
        return order === 'asc' ? A.localeCompare(B) : B.localeCompare(A);
      });
      $.each(rows, function(index, row) {
        $('#results-table tbody').append(row);
      });
    }
    $(document).on('click', '#results-table th', function() {
      const col = $(this).data('column');
      if (!col) return;
      const currentOrder = $(this).data('order') || 'asc';
      const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
      $(this).data('order', newOrder);
      sortTable(col, newOrder);
    });
  </script>
<!-- Modal OCR (Không có xem trước ảnh) -->
<div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; justify-content:center; align-items:center; z-index:9999; overflow-y:auto; transition: all 0.3s ease;">
<div style="background:#fff; padding:16px; border-radius:8px; width:95%; max-width:400px; text-align:center;">
<h3>📷 Quét Part Number</h3>
<div style="position: relative; width: 100%; max-height:240px;"><video autoplay="" id="camera" playsinline="" style="width:100%; max-height:240px; object-fit:cover; border-radius:6px;"></video><div id="ocrGuideBox" style="position: absolute; border: 2px solid red; top: 35%; left: 10%; width: 80%; height: 20%; box-sizing: border-box; pointer-events: none;"></div></div>
<div id="zoomContainer" style="display:none; margin:10px auto; text-align:center;">
  🔍 Zoom:
  <input id="zoomSlider" max="3" min="1" step="0.1" style="width:80%;" type="range" value="1"/>
</div>
<canvas height="240" id="canvas" style="display:none;" width="320"></canvas>
<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
<button id="btnCapture" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">📸 Chụp &amp; Quét</button>
<button id="btnApplyOcrFilter" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">✅ Lọc</button>
<button id="btnCloseCamera" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">❌ Đóng</button>
</div>
<input id="ocrInput" placeholder="Kết quả OCR..." style="margin-top:10px; width:100%; padding:8px; font-size:14px;" type="text"/>
<p id="ocrStatus" style="font-size:14px; margin-top:10px;">Đang chờ thao tác...</p>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btnScan = document.getElementById('btnScanCamera');
  const modal = document.getElementById('cameraModal');
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  const statusP = document.getElementById('ocrStatus');
  let inputOCR = document.getElementById('ocrInput');
  const btnCapture = document.getElementById('btnCapture');
  const btnClose = document.getElementById('btnCloseCamera');
  const btnApply = document.getElementById('btnApplyOcrFilter');
  const zoomSlider = document.getElementById("zoomSlider");
  const zoomContainer = document.getElementById("zoomContainer");
  let stream, intervalId;

  function stopStream() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    clearInterval(intervalId);
  }

  function cropCenterAndOCR(callback) {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
const cropWidth = canvas.width * 0.8;
const cropHeight = canvas.height * 0.2;

    const offsetX = canvas.width * 0.1;
    const offsetY = canvas.height * 0.35;
    const imageData = ctx.getImageData(offsetX, offsetY, cropWidth, cropHeight);
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = cropWidth;
    tempCanvas.height = cropHeight;
    tempCanvas.getContext("2d").putImageData(imageData, 0, 0);

    Tesseract.recognize(tempCanvas.toDataURL(), 'eng')
      .then(({ data: { text } }) => callback(text))
      .catch(() => statusP.textContent = '❌ Lỗi khi nhận diện.');
  }

  btnScan.addEventListener('click', async () => {
    modal.style.display = 'flex';
    statusP.textContent = '🔄 Đang khởi động camera...';
    inputOCR.value = '';
    document.getElementById("ocrInput").style.display = 'block';
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      video.play();

      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.zoom) {
        zoomContainer.style.display = 'block';
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step || 0.1;
        zoomSlider.value = capabilities.zoom.min;
        zoomSlider.addEventListener("input", () => {
          track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
        });
      }
      statusP.textContent = '✅ Đã kết nối camera. Nhấn "Chụp & Quét" hoặc giữ chế độ tự động';
    } catch (err) {
      statusP.textContent = '❌ Không thể truy cập camera.';
    }
  });

  btnCapture.addEventListener('click', () => {
    statusP.textContent = '🔍 Đang quét...';
    cropCenterAndOCR((text) => {
      const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
      if (lines.length === 0) return statusP.textContent = '❌ Không nhận được dòng nào.';

      if (lines.length === 1) {
        inputOCR.value = lines[0];
        statusP.textContent = '✅ Đã nhận 1 dòng.';
      } else {
        const selectHTML = `
          <select id="ocrLineSelector" style="width:100%; padding:8px; font-size:14px; margin-top:10px;">
            ${lines.map(l => `<option>${l}</option>`).join('')}
          </select>
        `;
        inputOCR.insertAdjacentHTML('beforebegin', selectHTML);
        const selector = document.getElementById('ocrLineSelector');
        selector.addEventListener('change', () => {
          inputOCR.value = selector.value;
        });
        inputOCR.value = lines[0];
        statusP.textContent = `✅ Đã nhận ${lines.length} dòng. Đã chọn dòng đầu tiên, có thể chỉnh sửa.`;
      }
    });
  });

  btnApply.addEventListener('click', () => {
    const part = inputOCR.value.trim();
    if (!part) return alert('Bạn chưa nhập Part Number!');
    $('#filter-column-1').val('Part Number').trigger('change');
    $('#filter-value-1').append(new Option(part, part, true, true)).trigger('change');
    if (typeof applyFilters === 'function') applyFilters(true);
    statusP.textContent = `✅ Đã lọc với Part Number: ${part}`;
    setTimeout(() => btnClose.click(), 1500);
  });

  btnClose.addEventListener('click', () => {
    modal.style.display = 'none';
    zoomContainer.style.display = 'none';
    stopStream();
    document.getElementById("ocrLineSelector")?.remove();
    inputOCR.value = '';
  });
});
</script>
<script>
window.addEventListener('resize', () => {
  const activeEl = document.activeElement;
  if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
    setTimeout(() => {
      activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }
});
</script><script>
// Scroll riêng cho input OCR khi focus (bàn phím mở lên)
document.addEventListener('DOMContentLoaded', function () {
  const ocrInput = document.getElementById('ocrInput');
  if (ocrInput) {
    ocrInput.addEventListener('focus', () => {
      setTimeout(() => {
        ocrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  }
});
</script><script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('ocrInput');
  if (input) {
    input.addEventListener('focus', () => {
      setTimeout(() => {
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  }
});
</script><script>
document.addEventListener('DOMContentLoaded', function () {
  const inputs = document.querySelectorAll('.filter-bar input, .filter-bar select');
  inputs.forEach((input) => {
    input.addEventListener('focus', () => {
      setTimeout(() => {
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const inputs = document.querySelectorAll('input, select, textarea');
  inputs.forEach((el) => {
    el.addEventListener('focus', () => {
      setTimeout(() => {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  });
});
</script>

</body>
</html>
