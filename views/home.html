<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Web Tra C·ª©u - Nguy·ªÖn VƒÉn ƒê·∫°o</title>
<!-- CSS Select2 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
<!-- Th√™m i18next v√† i18next-browser-languagedetector -->
<script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
<script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
<style>
    /* ƒêo·∫°n CSS responsive m√°y t√≠nh */
@media (min-width: 768px) {
  html, body {
    height: 100%;
    overflow: hidden;
  }

  body {
    overflow-y: auto;
  }

  input, select, textarea {
    touch-action: manipulation;
    -webkit-user-select: text;
    user-select: text;
    caret-color: auto;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    box-shadow: none;
  }
}
    /* C√†i ƒë·∫∑t CSS c∆° b·∫£n */
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: url('background.jpg') no-repeat center center/cover;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .page-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .top-container {
      flex: 0 0 auto;
      background: rgba(0, 0, 0, 0.85);
      padding: 15px;
      max-height: 40vh;
      overflow-y: auto;
      position: relative;
    }
    .header {
      text-align: center;
      padding: 10px;
      position: relative;
    }
    .tasks-link {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #fff;
  background: #007bff;
  padding: 5px 10px;
  border-radius: 4px;
  text-decoration: none;
  font-weight: bold;
  transition: background 0.3s;
}
.tasks-link:hover {
  background: #0056b3;
}
    .header h1 { margin: 0; font-size: 28px; color: white; }
    .header p { margin: 5px 0 0; font-size: 16px; color: #ddd; }
    /* Language switcher ·ªü g√≥c tr√™n b√™n ph·∫£i */
    .language-switcher {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .language-switcher button {
      padding: 4px 8px;
      margin-left: 5px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      border-radius: 3px;
      background: #ff8c00;
      color: white;
      transition: background 0.3s;
    }
    .language-switcher button:hover {
      background: #ff6500;
    }
    /* Kh·ªëi ch·ª©a c√°c ti√™u ch√≠ l·ªçc */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 5px;
    }
    .filter-block {
      background: #444;
      border-radius: 5px;
      padding: 5px;
      margin: 5px;
      width: 180px;
      font-size: 12px;
      color: white;
    }
    .filter-block label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }
    .filter-block select {
      width: 100%;
      padding: 3px;
      margin-bottom: 3px;
      font-size: 12px;
    }
    /* Kh·ªëi ch·ª©a c√°c n√∫t ch·ª©c nƒÉng */
    .action-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 5px;
    }
    .action-bar > div {
      background: #444;
      border-radius: 5px;
      padding: 5px;
      margin: 5px;
      font-size: 12px;
      color: white;
      text-align: center;
    }
    .action-bar button {
      padding: 6px 12px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.3s;
      margin: 3px;
    }
    .filter-actions button {
      background: linear-gradient(45deg, #ff8c00, #ff4500);
      color: white;
    }
    .filter-actions button:hover {
      background: linear-gradient(45deg, #ff6500, #ff0000);
    }
    .download-container button {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
    }
    .download-container button:hover {
      background: linear-gradient(45deg, #3399ff, #007bff);
    }
    .zoom-controls button {
      background: linear-gradient(45deg, #28a745, #218838);
      color: white;
    }
    .zoom-controls button:hover {
      background: linear-gradient(45deg, #34d058, #28a745);
    }
    /* Ph·∫ßn hi·ªÉn th·ªã t·ªïng s·ªë d√≤ng */
    .results-count {
      text-align: center;
      margin: 5px;
      font-size: 14px;
      color: white;
    }
    /* B·∫£ng d·ªØ li·ªáu */
    .table-container {
      flex: 1 1 auto;
      margin: 5px auto;
      width: 98%;
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      overflow-x: auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    table {
      width: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      padding: 6px 8px;
      border: 1px solid #ccc;
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #4a76a8;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .sticky-col-1 {
      position: sticky;
      left: 0;
      width: 40px;
      min-width: 40px;
      background: #4a76a8;
      z-index: 3;
    }
    .sticky-col-2 {
      position: sticky;
      left: 40px;
      width: 100px;
      min-width: 100px;
      background: #4a76a8;
      z-index: 3;
    }
    .sticky-col-3 {
      position: sticky;
      left: 140px;
      width: 50px;
      min-width: 50px;
      background: #4a76a8;
      z-index: 3;
    }
    td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
      background: #e6e6e6;
      color: #333;
      z-index: 1;
    }
    tr.selected { background-color: #ffeb99 !important; }
    .footer {
      flex: 0 0 auto;
      text-align: center;
      padding: 5px;
      font-size: 14px;
      background: #333;
      color: white;
    }
    @media (max-width: 768px) {
  /* ƒê∆∞a language switcher xu·ªëng d∆∞·ªõi ti√™u ƒë·ªÅ */
  .language-switcher {
    position: static;
    margin-top: 10px;
    text-align: center;
  }
  .language-switcher button {
    padding: 3px 6px;
    margin: 0 3px;
    font-size: 10px;
  }

  /* Gi·∫£m kho·∫£ng c√°ch v√† k√≠ch th∆∞·ªõc n√∫t ch·ª©c nƒÉng */
  .action-bar {
    justify-content: center;
    padding: 3px;
  }
  .action-bar > div {
    margin: 3px auto;
    padding: 3px;
    font-size: 14px;
  }
  .action-bar button {
    padding: 4px 8px;
    margin: 2px;
    font-size: 14px;
  }
}

    @media (max-width: 768px) {
      .filter-bar, .action-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-block, .action-bar > div {
        width: 90%;
        margin: 5px auto;
      }
      .header h1 { font-size: 24px; }
      .header p { font-size: 14px; }
      table, th, td { font-size: 10px; }
      .table-container {
        max-height: calc(100vh - 320px);
      }
    }
    @media (max-width: 480px) {
      .tasks-link {
    position: relative;
    top: 0;
    left: 0;
    display: block;
    width: 100%;
    text-align: center;
    padding: 10px 0;
    font-size: 16px;
  }
      .header h1 { font-size: 20px; }
      .header p { font-size: 12px; }
      table, th, td { font-size: 9px; }
    }
  
@media (max-width: 768px) {
  body {
    padding-bottom: 300px; /* ch·ª´a ch·ªó cho b√†n ph√≠m */
  }
}

@media screen and (orientation: landscape), (orientation: portrait) {
  .table-container {
    max-height: 60vh;
    overflow-y: auto;
    overflow-x: auto;
    touch-action: pan-y;
  }

  table {
    width: auto;
    min-width: 100%;
  }

  td, th {
    word-break: break-word;
  }
}

/* T·ªëi ∆∞u b·∫£ng cho ƒëi·ªán tho·∫°i xoay ngang/d·ªçc v√† khi m·ªü b√†n ph√≠m */
.table-container {
  width: 100vw;
  max-height: 50vh;
  overflow-x: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scroll-behavior: smooth;
  touch-action: auto;
}

@media screen and (orientation: landscape) {
  .table-container {
    max-height: 60vh;
  }
}

@media screen and (orientation: portrait) {
  .table-container {
    max-height: 50vh;
  }
}

table {
  min-width: 800px;
}

th, td {
  word-break: break-word;
  white-space: nowrap;
}

.table-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  max-height: 60vh;
  -webkit-overflow-scrolling: touch;
}
table {
  border-collapse: collapse;
  min-width: 1000px;
}
th, td {
  white-space: nowrap;
  padding: 6px;
  font-size: 12px;
}
.sticky-col-1 {
  position: sticky; left: 0; background: #4a76a8; z-index: 3;
}
.sticky-col-2 {
  position: sticky; left: 40px; background: #4a76a8; z-index: 3;
}
.sticky-col-3 {
  position: sticky; left: 140px; background: #4a76a8; z-index: 3;
}
td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
  background: #f3f3f3;
}

/* --- C·∫£i ti·∫øn cho input khi focus --- */
input:focus, select:focus {
  outline: 2px solid #ff8c00;
  background-color: #fffce6;
}

/* TƒÉng font input tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ d·ªÖ nh·∫≠p */
@media (max-width: 768px) {
  input, select {
    font-size: 16px;
  }
}

/* C·∫£i thi·ªán b·∫£ng khi xoay ngang */
@media screen and (orientation: landscape) {
  .top-container {
    max-height: 30vh;
    overflow-y: auto;
  }
  .table-container {
    height: auto;
    max-height: 90vh;
    min-height: 70vh;
    overflow-x: auto;
    overflow-y: auto;
  }
  table {
    min-width: 1200px;
  }
}


@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#results-table td, #results-table th {
  user-select: text;
}


@media (max-width: 768px) {
  .top-container {
    max-height: 25vh !important;
    padding: 8px !important;
    overflow-y: auto;
  }

  .header h1 { font-size: 20px; }
  .header p { font-size: 12px; }

  .filter-block,
  .action-bar > div {
    padding: 4px;
    margin: 3px;
    font-size: 11px;
  }

  .action-bar button,
  .language-switcher button {
    font-size: 16px;
    padding: 10px 16px;
  }

  .filter-block select {
    font-size: 12px;
  }

  .results-count {
    font-size: 12px;
  }

  #quick-search {
    font-size: 13px !important;
  }
}


/* Hi·ªáu ·ª©ng m∆∞·ª£t cho v√πng ƒë·ªông */
.top-container,
.table-container,
#quick-search {
  transition: all 0.3s ease-in-out;
}
.full-top-container {
  height: 100vh !important;
  max-height: 100vh !important;
  overflow-y: auto;
}
.hide-top-container {
  height: 0 !important;
  max-height: 0 !important;
  overflow: hidden;
  padding: 0 !important;
  opacity: 0;
  pointer-events: none;
}
.show-table-only {
  height: calc(100vh - 60px);
}
</style>
</head>
<body>
<div id="loading-spinner" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index:99;">
<div style="border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
</div>
<div class="page-container">
<div class="top-container">
<div class="header">
<a class="tasks-link" href="/tasks">Tasks</a>
<h1 id="header-title">FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR</h1>
<p id="header-subtitle">Tra c·ª©u t√¨nh tr·∫°ng FAIR</p>
<!-- N√∫t chuy·ªÉn ƒë·ªïi ng√¥n ng·ªØ ·ªü g√≥c tr√™n b√™n ph·∫£i -->
<div class="language-switcher">
<button onclick="changeLanguage('vi')">Vi</button>
<button onclick="changeLanguage('en')">En</button>
<button onclick="changeLanguage('ko')">Ko</button>
</div>
</div>
<!-- Ph·∫ßn ti√™u ch√≠ l·ªçc -->
<div class="filter-bar">
<!-- Filter Block Sheet -->
<div class="filter-block" id="filter-block-project">
<label for="filter-project" id="label-filter-project">Ch·ªçn d·ª± √°n (Customer)</label>
<select class="value-select" id="filter-project" multiple="multiple"></select>
</div>
<!-- Filter Block 1 -->
<div class="filter-block" id="filter-block-1">
<label for="filter-column-1" id="label-criteria-1">Ch·ªçn ti√™u ch√≠ s·ªë 1:</label>
<select id="filter-column-1">
<option selected="" value="Part Number">Part Number</option>
<option value="Approval Status">Approval Status</option>
<option value="Production Status">Production Status</option>
<option value="Part Pictures">Part Pictures</option>
<option value="Packaging Pictures">Packaging Pictures</option>
<option value="Customer">Customer</option>
<option value="Commodity">Commodity</option>
<option value="Critical">Critical</option>
<option value="CE">CE</option>
<option value="PO Number">PO Number</option>
<option value="Type">Type</option>
<option value="REV">REV</option>
<option value="Description">Description</option>
<option value="Note Number">Note Number</option>
<option value="PO received date">PO received date</option>
<option value="Customer need date">Customer need date</option>
<option value="Requirements">Requirements</option>
<option value="FAIR Cover sheet">FAIR Cover sheet</option>
<option value="Bubble Drawings">Bubble Drawings</option>
<option value="Datasheet form">Datasheet form</option>
<option value="LAIR data">LAIR data</option>
<option value="FAIR Data">FAIR Data</option>
<option value="COC">COC</option>
<option value="BOM">BOM</option>
<option value="Mill">Mill</option>
<option value="Test reports / evidences">Test reports / evidences</option>
<option value="Remark 1">Remark 1</option>
<option value="Remark 2">Remark 2</option>
<option value="Submit date">Submit date</option>
<option value="Reject comments">Reject comments</option>
</select>
<label for="filter-value-1" id="label-filter-value-1">Ch·ªçn gi√° tr·ªã</label>
<select class="value-select" id="filter-value-1" multiple="multiple"></select>
</div>
<!-- Filter Block 2 -->
<div class="filter-block" id="filter-block-2">
<label for="filter-column-2" id="label-criteria-2">Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):</label>
<select id="filter-column-2">
<option selected="" value="Part Number">Part Number</option>
<option value="Approval Status">Approval Status</option>
<option value="Production Status">Production Status</option>
<option value="Part Pictures">Part Pictures</option>
<option value="Packaging Pictures">Packaging Pictures</option>
<option value="Customer">Customer</option>
<option value="Commodity">Commodity</option>
<option value="Critical">Critical</option>
<option value="CE">CE</option>
<option value="PO Number">PO Number</option>
<option value="Type">Type</option>
<option value="REV">REV</option>
<option value="Description">Description</option>
<option value="Note Number">Note Number</option>
<option value="PO received date">PO received date</option>
<option value="Customer need date">Customer need date</option>
<option value="Requirements">Requirements</option>
<option value="FAIR Cover sheet">FAIR Cover sheet</option>
<option value="Bubble Drawings">Bubble Drawings</option>
<option value="Datasheet form">Datasheet form</option>
<option value="LAIR data">LAIR data</option>
<option value="FAIR Data">FAIR Data</option>
<option value="COC">COC</option>
<option value="BOM">BOM</option>
<option value="Mill">Mill</option>
<option value="Test reports / evidences">Test reports / evidences</option>
<option value="Remark 1">Remark 1</option>
<option value="Remark 2">Remark 2</option>
<option value="Submit date">Submit date</option>
<option value="Reject comments">Reject comments</option>
</select>
<label for="filter-value-2" id="label-filter-value-2">Ch·ªçn gi√° tr·ªã</label>
<select id="filter-value-2" multiple="multiple"></select>
</div>
<!-- Filter Block 3 -->
<div class="filter-block" id="filter-block-3">
<label for="filter-column-3" id="label-criteria-3">Ch·ªçn ti√™u ch√≠ s·ªë 3:</label>
<select id="filter-column-3">
<option selected="" value="Part Number">Part Number</option>
<option value="Approval Status">Approval Status</option>
<option value="Production Status">Production Status</option>
<option value="Part Pictures">Part Pictures</option>
<option value="Packaging Pictures">Packaging Pictures</option>
<option value="Customer">Customer</option>
<option value="Commodity">Commodity</option>
<option value="Critical">Critical</option>
<option value="CE">CE</option>
<option value="PO Number">PO Number</option>
<option value="Type">Type</option>
<option value="REV">REV</option>
<option value="Description">Description</option>
<option value="Note Number">Note Number</option>
<option value="PO received date">PO received date</option>
<option value="Customer need date">Customer need date</option>
<option value="Requirements">Requirements</option>
<option value="FAIR Cover sheet">FAIR Cover sheet</option>
<option value="Bubble Drawings">Bubble Drawings</option>
<option value="Datasheet form">Datasheet form</option>
<option value="LAIR data">LAIR data</option>
<option value="FAIR Data">FAIR Data</option>
<option value="COC">COC</option>
<option value="BOM">BOM</option>
<option value="Mill">Mill</option>
<option value="Test reports / evidences">Test reports / evidences</option>
<option value="Remark 1">Remark 1</option>
<option value="Remark 2">Remark 2</option>
<option value="Submit date">Submit date</option>
<option value="Reject comments">Reject comments</option>
</select>
<label for="filter-value-3" id="label-filter-value-3">Ch·ªçn gi√° tr·ªã</label>
<select class="value-select" id="filter-value-3" multiple="multiple"></select>
</div>
</div>
<!-- Kh·ªëi ch·ª©a c√°c n√∫t ch·ª©c nƒÉng -->
<div class="action-bar">
<div class="filter-actions">
<button id="apply-filters">√Åp D·ª•ng L·ªçc</button>
<button id="clear-filters">X√≥a L·ªçc</button>
</div>
<div class="download-container">
<button id="download-excel">Xu·∫•t Excel (ƒêang xem)</button>
<button id="export-all">Xu·∫•t Excel (T·∫•t c·∫£)</button>
</div>
<div class="zoom-controls">
<button id="zoom-in">Ph√≥ng to</button>
<button id="zoom-out">Thu nh·ªè</button>
</div>
</div>
<!-- Ph·∫ßn hi·ªÉn th·ªã t·ªïng s·ªë d√≤ng -->
<div class="scan-camera" style="text-align:center; margin-top:10px;">
<button id="btnScanCamera">üì∑ Qu√©t Camera</button>
</div>
<div class="results-count" id="results-count">Total rows: 0</div>
</div>
<div style="text-align:center; margin: 10px;">
<input id="quick-search" placeholder="üîç T√¨m Part Number..." style="padding:5px; width: 60%; font-size:14px;" type="text"/>
</div>
<!-- Khu v·ª±c hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu -->
<div class="table-container">
<table id="results-table">
<thead><tr>
<th class="sticky-col-1" data-column="No">No</th>
<th class="sticky-col-2" data-column="Part Number">Part Number</th>
<th class="sticky-col-3" data-column="REV">REV</th>
<th data-column="Approval Status">Approval Status</th>
<th data-column="Customer">Customer</th>
<th data-column="Commodity">Commodity</th>
<th data-column="Production Status">Production Status</th>
<th data-column="Part Pictures">Part Pictures</th>
<th data-column="Packaging Pictures">Packaging Pictures</th>
<th data-column="Critical">Critical</th>
<th data-column="CE">CE</th>
<th data-column="PO Number">PO Number</th>
<th data-column="Description">Description</th>
<th data-column="Type">Type</th>
<th data-column="Note Number">Note Number</th>
<th data-column="PO received date">PO received date</th>
<th data-column="Customer need date">Customer need date</th>
<th data-column="Requirements">Requirements</th>
<th data-column="FAIR Cover sheet">FAIR Cover sheet</th>
<th data-column="Bubble Drawings">Bubble Drawings</th>
<th data-column="Datasheet form">Datasheet form</th>
<th data-column="LAIR Data">LAIR Data</th>
<th data-column="FAIR Data">FAIR Data</th>
<th data-column="COC">COC</th>
<th data-column="BOM">BOM</th>
<th data-column="Mill">Mill</th>
<th data-column="Test reports / evidences">Test reports / evidences</th>
<th data-column="Remark 1">Remark 1</th>
<th data-column="Remark 2">Remark 2</th>
<th data-column="Submit date">Submit date</th>
<th data-column="Reject comments">Reject comments</th>
</tr></thead>
<tbody>
<!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load t·∫°i ƒë√¢y -->
</tbody>
</table>
</div>
<!-- N√∫t t·∫£i th√™m -->
<div id="load-more-container" style="text-align:center; margin:10px;">
<button id="load-more">Load More</button>
<button id="load-all">Load All</button>
</div>
<!-- Footer -->
<div class="footer" id="footer-text">Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o</div>
</div>
<!-- JS Th∆∞ vi·ªán -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>
<!-- i18next Integration -->
<script>
    // Kh·ªüi t·∫°o i18next v·ªõi resource cho ti·∫øng Anh v√† ti·∫øng Vi·ªát
    i18next.use(i18nextBrowserLanguageDetector).init({
      fallbackLng: 'vi',
      debug: false,
      resources: {
        en: {
          translation: {
            "header_title": "FAIR TEAM - Search Status",
            "header_subtitle": "Search FAIR status",
            "choose_project": "Choose Project",
            "choose_value": "Choose Value",
            "choose_criteria_1": "Select Criteria 1:",
            "choose_criteria_2": "Select Criteria 2 (paste excel):",
            "choose_criteria_3": "Select Criteria 3:",
            "apply_filter": "Apply Filter",
            "clear_filter": "Clear Filter",
            "download_excel": "Export Excel (Current)",
            "export_all": "Export Excel (All)",
            "zoom_in": "Zoom In",
            "zoom_out": "Zoom Out",
            "load_more": "Load More",
            "load_all": "Load All",
            "total_rows": "Total rows: {{count}} / {{total}}",
            "developer": "Developer: Nguy·ªÖn VƒÉn ƒê·∫°o"
          }
        },
        ko: {
  translation: {
    "header_title": "FAIR TEAM - Í≤ÄÏÉâ ÏÉÅÌÉú",
    "header_subtitle": "FAIR ÏÉÅÌÉú Í≤ÄÏÉâ",
    "choose_project": "ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù",
    "choose_value": "Í∞í ÏÑ†ÌÉù",
    "choose_criteria_1": "Í∏∞Ï§Ä 1 ÏÑ†ÌÉù:",
    "choose_criteria_2": "Í∏∞Ï§Ä 2 ÏÑ†ÌÉù (ÏóëÏÖÄ Î∂ôÏó¨ÎÑ£Í∏∞):",
    "choose_criteria_3": "Í∏∞Ï§Ä 3 ÏÑ†ÌÉù:",
    "apply_filter": "ÌïÑÌÑ∞ Ï†ÅÏö©",
    "clear_filter": "ÌïÑÌÑ∞ ÏßÄÏö∞Í∏∞",
    "download_excel": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌòÑÏû¨ Î≥¥Í∏∞)",
    "export_all": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Ï†ÑÏ≤¥)",
    "zoom_in": "ÌôïÎåÄ",
    "zoom_out": "Ï∂ïÏÜå",
    "load_more": "Îçî Î∂àÎü¨Ïò§Í∏∞",
    "load_all": "Ï†ÑÏ≤¥ Î∂àÎü¨Ïò§Í∏∞",
    "total_rows": "Ï¥ù Ìñâ: {{count}} / {{total}}",
    "developer": "Í∞úÎ∞úÏûê: Nguy·ªÖn VƒÉn ƒê·∫°o"
  }
},

        vi: {
          translation: {
            "header_title": "FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR",
            "header_subtitle": "Tra c·ª©u t√¨nh tr·∫°ng FAIR",
            "choose_project": "Ch·ªçn d·ª± √°n",
            "choose_value": "Ch·ªçn gi√° tr·ªã",
            "choose_criteria_1": "Ch·ªçn ti√™u ch√≠ s·ªë 1:",
            "choose_criteria_2": "Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):",
            "choose_criteria_3": "Ch·ªçn ti√™u ch√≠ s·ªë 3:",
            "apply_filter": "√Åp d·ª•ng l·ªçc",
            "clear_filter": "X√≥a l·ªçc",
            "download_excel": "Xu·∫•t Excel (ƒêang xem)",
            "export_all": "Xu·∫•t Excel (T·∫•t c·∫£)",
            "zoom_in": "Ph√≥ng to",
            "zoom_out": "Thu nh·ªè",
            "load_more": "T·∫£i th√™m",
            "load_all": "T·∫£i to√†n b·ªô",
            "total_rows": "T·ªïng s·ªë d√≤ng: {{count}} / {{total}}",
            "developer": "Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o"
          }
        }
      }
    }, function(err, t) {
      updateStaticContent();
    });

    // H√†m t√°i kh·ªüi t·∫°o l·∫°i widget Select2 ƒë·ªÉ c·∫≠p nh·∫≠t placeholder v√† gi·ªØ l·ª±a ch·ªçn hi·ªán t·∫°i
    function reinitializeSelect2(selector, placeholder, extraOptions) {
      var $el = $(selector);
      var currentValue = $el.val();
      $el.select2("destroy");
      $el.select2($.extend({
        placeholder: placeholder,
        allowClear: true,
        width: '100%'
      }, extraOptions));
      $el.val(currentValue).trigger('change');
    }

    // H√†m c·∫≠p nh·∫≠t n·ªôi dung tƒ©nh theo ng√¥n ng·ªØ hi·ªán t·∫°i
    function updateStaticContent() {
      // Header
      document.getElementById("header-title").innerText = i18next.t("header_title");
      document.getElementById("header-subtitle").innerText = i18next.t("header_subtitle");

      // C√°c label trong filter
      var labelSheet = document.querySelector('label[for="filter-project"]');
      if (labelSheet) { labelSheet.innerText = i18next.t("choose_project"); }
      var labelCriteria1 = document.getElementById("label-criteria-1");
      if (labelCriteria1) { labelCriteria1.innerText = i18next.t("choose_criteria_1"); }
      var labelCriteria2 = document.getElementById("label-criteria-2");
      if (labelCriteria2) { labelCriteria2.innerText = i18next.t("choose_criteria_2"); }
      var labelCriteria3 = document.getElementById("label-criteria-3");
      if (labelCriteria3) { labelCriteria3.innerText = i18next.t("choose_criteria_3"); }
      var labelValue1 = document.getElementById("label-filter-value-1");
      if (labelValue1) { labelValue1.innerText = i18next.t("choose_value"); }
      var labelValue2 = document.getElementById("label-filter-value-2");
      if (labelValue2) { labelValue2.innerText = i18next.t("choose_value"); }
      var labelValue3 = document.getElementById("label-filter-value-3");
      if (labelValue3) { labelValue3.innerText = i18next.t("choose_value"); }
      var tbodyCount = $('#results-table tbody').children().length;
      $('#results-count').text(i18next.t("total_rows", { count: tbodyCount, total: totalData }));


      // C·∫≠p nh·∫≠t l·∫°i c√°c widget Select2 (ƒë·ªÉ thay ƒë·ªïi placeholder m√† v·∫´n gi·ªØ l·ª±a ch·ªçn)
      reinitializeSelect2('#filter-project', i18next.t("choose_project"), { closeOnSelect: false });
      reinitializeSelect2('#filter-value-1', i18next.t("choose_value"), { closeOnSelect: false });
      reinitializeSelect2('#filter-value-2', i18next.t("choose_value"), {}); // m·∫∑c ƒë·ªãnh closeOnSelect = true
      reinitializeSelect2('#filter-value-3', i18next.t("choose_value"), { closeOnSelect: false });

      // Action buttons
      document.getElementById("apply-filters").innerText = i18next.t("apply_filter");
      document.getElementById("clear-filters").innerText = i18next.t("clear_filter");
      document.getElementById("download-excel").innerText = i18next.t("download_excel");
      document.getElementById("export-all").innerText = i18next.t("export_all");
      document.getElementById("zoom-in").innerText = i18next.t("zoom_in");
      document.getElementById("zoom-out").innerText = i18next.t("zoom_out");

      // Update "Load More" and "Load All" buttons
      document.getElementById("load-more").innerText = i18next.t("load_more");
      document.getElementById("load-all").innerText = i18next.t("load_all");

      // Update footer text
      document.getElementById("footer-text").innerText = i18next.t("developer");
    }

    // H√†m chuy·ªÉn ƒë·ªïi ng√¥n ng·ªØ khi b·∫•m n√∫t
    function changeLanguage(lng) {
      i18next.changeLanguage(lng, function() {
        updateStaticContent();
      });
    }
  </script>
<!-- C√°c m√£ JS hi·ªán t·∫°i -->
<script>
    // H√†m format Excel date
    function formatExcelDate(val) {
  if (!val) return '';
  if (typeof val === 'number') {
    // N·∫øu l√† s·ªë serial ng√†y t·ª´ Excel
    let date = new Date((val - 25569) * 86400 * 1000);
    if (!isNaN(date)) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }
  } else if (typeof val === 'string') {
    // N·∫øu l√† chu·ªói ng√†y d·∫°ng ISO ho·∫∑c c√≥ gi·ªù
    const parsed = new Date(val);
    if (!isNaN(parsed)) {
      const yyyy = parsed.getFullYear();
      const mm = String(parsed.getMonth() + 1).padStart(2, '0');
      const dd = String(parsed.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }
  }
  return val;
}

    let currentFilters = {};
    let currentOffset = 0;
    const pageSize = 50;
    let totalData = 0;
    let currentZoom = 1;
    // Bi·∫øn ch·ª©a to√†n b·ªô d·ªØ li·ªáu
    let allData = null;

    // H√†m load to√†n b·ªô d·ªØ li·ªáu khi trang m·ªü
    function loadAllData() {
      $.getJSON('/search?limit=1000000', function(response) {
        allData = response.data;
        totalData = response.total; // Update totalData here
      });
    }

    // H√†m load d·ªØ li·ªáu d·ª± √°n cho ph·∫ßn "Ch·ªçn d·ª± √°n"
    function loadDistinctValuesForProject() {
      const selectElem = $('#filter-project');
      selectElem.empty();
      $.getJSON('/filters', function(data) {
if (data['Customer']) {
  data['Customer'].forEach(function(val) {
    const option = new Option(val, val, false, false);
    selectElem.append(option);
  });
}
        selectElem.trigger('change');
      });
    }




    $(document).ready(function() {
      loadAllData(); // T·∫£i to√†n b·ªô d·ªØ li·ªáu m·ªôt l·∫ßn

      // Kh·ªüi t·∫°o Select2 ban ƒë·∫ßu
      $('.value-select').not('#filter-value-2').select2({
        placeholder: i18next.t("choose_value"),
        allowClear: true,
        width: '100%',
        closeOnSelect: false
      });
      $('#filter-project').select2({
        placeholder: i18next.t("choose_project"),
        allowClear: true,
        width: '100%',
        closeOnSelect: false
      });
      $('#filter-value-2').select2({
        placeholder: i18next.t("choose_value"),
        allowClear: true,
        width: '100%'
      });

      // Load d·ªØ li·ªáu cho "Ch·ªçn d·ª± √°n"
      loadDistinctValuesForProject();

      // X·ª≠ l√Ω paste Excel cho filter-value-2
      $(document).on('paste', '#filter-value-2 ~ .select2 .select2-search__field', function(e) {
        e.preventDefault();
        var clipboardData = e.originalEvent.clipboardData.getData('text/plain');
        var values = clipboardData.split(/\r?\n/).reduce(function(acc, line) {
          return acc.concat(line.split('\t'));
        }, []).filter(function(val) {
          return val.trim() !== '';
        });
        var $select = $('#filter-value-2');
        var currentValues = $select.val() || [];
        var newValues = currentValues.concat(values);
        newValues = Array.from(new Set(newValues));
        $select.val(newValues).trigger('change');
      });

      // Khi ch·ªçn d·ª± √°n => c·∫≠p nh·∫≠t block 1, cascade block 2
      $('#filter-project').on('change', function(){
        updateFilterValuesForBlock(1);
        updateCascade(2);
      });
      // Ban ƒë·∫ßu, c·∫≠p nh·∫≠t block 1
      updateFilterValuesForBlock(1);

      // S·ª± ki·ªán thay ƒë·ªïi ti√™u ch√≠ v√† gi√° tr·ªã cho c√°c block
      $('#filter-column-1').on('change', function() {
        updateFilterValuesForBlock(1);
        updateCascade(2);
      });
      $('#filter-value-1').on('change', function() {
        updateCascade(2);
      });
      $('#filter-column-2').on('change', function() {
        updateFilterValuesForBlock(2);
        updateCascade(3);
      });
      $('#filter-value-2').on('change', function() {
        updateCascade(3);
      });
      $('#filter-column-3').on('change', function() {
        updateFilterValuesForBlock(3);
      });

      // C√°c n√∫t ch·ª©c nƒÉng: L·ªçc, X√≥a, T·∫£i th√™m, Xu·∫•t Excel, Zoom
      $('#apply-filters').on('click', function() {
        const col1 = $('#filter-column-1').val();
        const val1 = $('#filter-value-1').val();
        if (col1 === 'Part Number' && val1 && val1.length > 0) {
          val1.forEach(p => saveSearchHistory(p));
        }
        applyFilters(true);
      });
      $('#clear-filters').on('click', function() {
        $('.value-select').val(null).trigger('change');
        $('#filter-value-2').val(null).trigger('change');
        applyFilters(true);
      });
      $('#load-more').on('click', function() {
        if (currentOffset < totalData) {
          let queryString = $.param(currentFilters);
          $.getJSON(`/search?${queryString}&offset=${currentOffset}`, function(response) {
            currentOffset += pageSize;
            updateTable(response.data, false);
          });
        } else {
          alert("ƒê√£ t·∫£i h·∫øt d·ªØ li·ªáu!");
        }
      });
      $('#load-all').on('click', function() {
        let queryParams = {};
        const sheetValues = $('#filter-project').val();
        if (sheetValues && sheetValues.length > 0) {
          queryParams["Customer"] = sheetValues.join(',');
        }
        for (let i = 1; i <= 3; i++) {
          const col = $(`#filter-column-${i}`).val();
          const values = $(`#filter-value-${i}`).val();
          if (values && values.length > 0) {
            queryParams[col] = values.join(',');
          }
        }
        queryParams.limit = 1000000;
        queryParams.offset = 0;
        const queryString = $.param(queryParams);
        $.getJSON(`/search?${queryString}`, function(response) {
          currentOffset = response.total;
          updateTable(response.data, true);
        });
      });
      $('#download-excel').on('click', function() { downloadExcel(); });
      $('#export-all').on('click', function() {
        let queryParams = {};
        const sheetValues = $('#filter-project').val();
        if (sheetValues && sheetValues.length > 0) {
          queryParams["Customer"] = sheetValues.join(',');
        }
        for (let i = 1; i <= 3; i++) {
          const col = $(`#filter-column-${i}`).val();
          const values = $(`#filter-value-${i}`).val();
          if (values && values.length > 0) {
            queryParams[col] = values.join(',');
          }
        }
        const queryString = $.param(queryParams);
        window.location.href = `/export?${queryString}`;
      });
      $('#zoom-in').on('click', function() {
        currentZoom += 0.1;
        $('#results-table').css('zoom', currentZoom);
      });
      $('#zoom-out').on('click', function() {
        if (currentZoom > 0.5) {
          currentZoom -= 0.1;
          $('#results-table').css('zoom', currentZoom);
        }
      });
      // Check if colResizable is available before using it
      try {
        if (typeof $.fn.colResizable === 'function') {
          $('#results-table').colResizable({ liveDrag: true });
        }
      } catch(e) {
        console.log("colResizable not available:", e);
      }

      applyFilters(true);
    });

    // H√†m c·∫≠p nh·∫≠t dropdown cho blockIndex d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ l·ªçc
    function updateFilterValuesForBlock(blockIndex) {
      if (!allData) {
        setTimeout(function(){ updateFilterValuesForBlock(blockIndex); }, 100);
        return;
      }
      let filteredData = allData.slice();

      // L·ªçc theo d·ª± √°n (Sheet)
      const sheetValues = $('#filter-project').val();
      if (sheetValues && sheetValues.length > 0) {
        filteredData = filteredData.filter(function(row) {
          return sheetValues.some(function(s) {
            return row['Customer'] && row['Customer'].toString().toLowerCase().includes(s.toLowerCase());
          });
        });
      }
      // L·ªçc theo c√°c block tr∆∞·ªõc (block 1 ƒë·∫øn blockIndex - 1)
      for (let i = 1; i < blockIndex; i++) {
        let col = $('#filter-column-' + i).val();
        let values = $('#filter-value-' + i).val();
        if (col && values && values.length > 0) {
          filteredData = filteredData.filter(function(row) {
            return values.some(function(v) {
              return row[col] && row[col].toString().toLowerCase().includes(v.toLowerCase());
            });
          });
        }
      }
      // L·∫•y gi√° tr·ªã distinct cho c·ªôt c·ªßa block hi·ªán t·∫°i
      let dependentColumn = $('#filter-column-' + blockIndex).val();
      let values = filteredData.map(function(row) {
        let cellVal = row[dependentColumn];
        if (cellVal == null) return "";
        if (typeof cellVal === 'string') {
          return cellVal.trim().toUpperCase();
        }
        return cellVal.toString();
      }).filter(function(v) { return v !== ""; });
      let distinctValues = Array.from(new Set(values));
      distinctValues.sort((a, b) => a.localeCompare(b));

      const selectElem = $('#filter-value-' + blockIndex);
      selectElem.empty();
      distinctValues.forEach(function(val) {
        const option = new Option(val, val, false, false);
        selectElem.append(option);
      });
      selectElem.trigger('change');
    }

    // H√†m cascade: c·∫≠p nh·∫≠t c√°c block t·ª´ startBlock ƒë·∫øn 3
    function updateCascade(startBlock) {
      for (let i = startBlock; i <= 3; i++) {
        updateFilterValuesForBlock(i);
      }
    }

    // H√†m √°p d·ª•ng l·ªçc (ch·ªâ duy·ªát qua 3 ti√™u ch√≠)
    function applyFilters(reset = true) {
      if (reset) {
        currentOffset = 0;
        $('#results-table tbody').empty();
      }
      let queryParams = { limit: pageSize, offset: currentOffset };
      const sheetValues = $('#filter-project').val();
      if (sheetValues && sheetValues.length > 0) {
        queryParams["Customer"] = sheetValues.join(',');
      }
      for (let i = 1; i <= 3; i++) {
        const col = $(`#filter-column-${i}`).val();
        const values = $(`#filter-value-${i}`).val();
        if (values && values.length > 0) {
          queryParams[col] = values.join(',');
        }
      }
      currentFilters = queryParams;
      const queryString = $.param(queryParams);
      $.getJSON(`/search?${queryString}`, function(response) {
        totalData = response.total;
        currentOffset += pageSize;
        updateTable(response.data, true);
      });
    }

    // H√†m c·∫≠p nh·∫≠t b·∫£ng d·ªØ li·ªáu
function updateTable(data, reset) {
  const tbody = $('#results-table tbody');
  if (reset) tbody.empty();
  
  data.forEach(function(row) {
    const serial = tbody.children().length + 1;
    const tr = $('<tr>');

    // C√°c c·ªôt c·ªë ƒë·ªãnh v√† c√°c c·ªôt theo th·ª© t·ª± ƒë√£ ƒë·ªãnh
    tr.append(`<td class="sticky-col-1">${serial}</td>`);
    tr.append(`<td class="sticky-col-2">${row['Part Number'] || ''}</td>`);
    tr.append(`<td class="sticky-col-3">${row['REV'] || ''}</td>`);
    tr.append(`<td>${row['Approval Status'] || ''}</td>`);
    tr.append(`<td>${row['Customer'] || ''}</td>`);
    tr.append(`<td>${row['Commodity'] || ''}</td>`);
    tr.append(`<td>${row['Production Status'] || ''}</td>`);
    tr.append(`<td>${row['Part Pictures'] || ''}</td>`);
    tr.append(`<td>${row['Packaging Pictures'] || ''}</td>`);
    tr.append(`<td>${row['Critical'] || ''}</td>`);
    tr.append(`<td>${row['CE'] || ''}</td>`);
    tr.append(`<td>${row['PO Number'] || ''}</td>`);
    tr.append(`<td>${row['Description'] || ''}</td>`);
    tr.append(`<td>${row['Type'] || ''}</td>`);
    tr.append(`<td>${row['Note Number'] || ''}</td>`);
    tr.append(`<td>${formatExcelDate(row['PO received date'])}</td>`);
    tr.append(`<td>${formatExcelDate(row['Customer need date'])}</td>`);
    tr.append(`<td>${row['Requirements'] || ''}</td>`);
    tr.append(`<td>${row['FAIR Cover sheet'] || ''}</td>`);
    tr.append(`<td>${row['Bubble Drawings'] || ''}</td>`);
    tr.append(`<td>${row['Datasheet form'] || ''}</td>`);
    tr.append(`<td>${row['LAIR Data'] || row['LAIR data'] || ''}</td>`);
    tr.append(`<td>${row['FAIR Data'] || ''}</td>`);
    tr.append(`<td>${row['COC'] || ''}</td>`);
    tr.append(`<td>${row['BOM'] || ''}</td>`);
    tr.append(`<td>${row['Mill'] || ''}</td>`);
    tr.append(`<td>${row['Test reports / evidences'] || ''}</td>`);
    tr.append(`<td>${row['Remark 1'] || ''}</td>`);
    tr.append(`<td>${row['Remark 2'] || ''}</td>`);
    tr.append(`<td>${formatExcelDate(row['Submit date'])}</td>`);
    tr.append(`<td>${row['Reject comments'] || ''}</td>`);

    tbody.append(tr);
  });

  var totalText = i18next.t("total_rows", { count: tbody.children().length, total: totalData });
  $('#results-count').text(totalText);

  // S·ª≠ d·ª•ng colResizable n·∫øu c√≥
  try {
    if (typeof $.fn.colResizable === 'function') {
      $('#results-table').colResizable({ liveDrag: true });
    }
  } catch (e) {
    console.log("colResizable not available in updateTable:", e);
  }
}

    // H√†m xu·∫•t Excel
function downloadExcel() {
  const table = document.getElementById('results-table');
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
  const rows = Array.from(table.querySelectorAll('tbody tr'));

  const dateColumns = ['PO received date', 'Customer need date', 'Submit date'];

  const data = rows.map(tr => {
    const cells = Array.from(tr.querySelectorAll('td'));
    const rowObj = {};
    cells.forEach((td, index) => {
      let val = td.textContent.trim();
      const header = headers[index];
      if (dateColumns.includes(header)) {
        val = formatExcelDate(val); // x·ª≠ l√Ω chu·∫©n ng√†y
      }
      rowObj[header] = val;
    });
    return rowObj;
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
  XLSX.writeFile(wb, 'ketqua.xlsx');
}


    // H√†m s·∫Øp x·∫øp b·∫£ng khi click ti√™u ƒë·ªÅ c·ªôt
    function getColumnIndex(columnName) {
      let index = -1;
      $('#results-table th').each(function(i) {
        if ($(this).data('column') === columnName) {
          index = i;
          return false;
        }
      });
      return index;
    }
    function sortTable(column, order) {
      let rows = $('#results-table tbody tr').get();
      let colIndex = getColumnIndex(column);
      if (colIndex === -1) return;
      rows.sort(function(a, b) {
        let A = $(a).children('td').eq(colIndex).text().toUpperCase();
        let B = $(b).children('td').eq(colIndex).text().toUpperCase();
        return order === 'asc' ? A.localeCompare(B) : B.localeCompare(A);
      });
      $.each(rows, function(index, row) {
        $('#results-table tbody').append(row);
      });
    }
    $(document).on('click', '#results-table th', function () {
  const col = $(this).data('column');
  if (!col) return;

  const currentOrder = $(this).data('order') || 'asc';
  const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

  $('#results-table th').each(function () {
    $(this).data('order', null);
    const text = $(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim();
    $(this).text(text);
  });

  const arrow = newOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
  $(this).text($(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim() + arrow);
  $(this).data('order', newOrder);

  sortTable(col, newOrder);
});
  </script>
<!-- Modal OCR (Kh√¥ng c√≥ xem tr∆∞·ªõc ·∫£nh) -->
<div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; justify-content:center; align-items:center; z-index:9999; overflow-y:auto; transition: all 0.3s ease;">
<div style="background:#fff; padding:16px; border-radius:8px; width:95%; max-width:400px; text-align:center; margin-bottom: 10vh;">
<h3>üì∑ Qu√©t Part Number</h3>
<div style="position: relative; width: 100%; max-height:240px;"><video autoplay="" id="camera" playsinline="" style="width:100%; max-height:240px; object-fit:cover; border-radius:6px;"></video><div id="ocrGuideBox" style="position: absolute; border: 2px solid red; top: 35%; left: 10%; width: 80%; height: 20%; box-sizing: border-box; pointer-events: none;"></div></div>
<div id="zoomContainer" style="display:none; margin:10px auto; text-align:center;">
  üîç Zoom:
  <input id="zoomSlider" max="3" min="1" step="0.1" style="width:80%;" type="range" value="1"/>
</div>
<canvas height="240" id="canvas" style="display:none;" width="320"></canvas>
<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
<button id="btnCapture" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">üì∏ Ch·ª•p &amp; Qu√©t</button>
<button id="btnApplyOcrFilter" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">‚úÖ L·ªçc</button>
<button id="btnCloseCamera" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">‚ùå ƒê√≥ng</button>
</div>
<input id="ocrInput" placeholder="K·∫øt qu·∫£ OCR..." style="margin-top:10px; width:100%; padding:8px; font-size:14px;" type="text"/>
<p id="ocrStatus" style="font-size:14px; margin-top:10px; margin-bottom: 20px; display: block;">ƒêang ch·ªù thao t√°c...</p>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btnScan = document.getElementById('btnScanCamera');
  const modal = document.getElementById('cameraModal');
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  const statusP = document.getElementById('ocrStatus');
  let inputOCR = document.getElementById('ocrInput');
  const btnCapture = document.getElementById('btnCapture');
  const btnClose = document.getElementById('btnCloseCamera');
  const btnApply = document.getElementById('btnApplyOcrFilter');
  const zoomSlider = document.getElementById("zoomSlider");
  const zoomContainer = document.getElementById("zoomContainer");
  let stream, intervalId;

  function stopStream() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      video.srcObject = null;
    }
    clearInterval(intervalId);
  }

  function cropCenterAndOCR(callback) {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
const cropWidth = canvas.width * 0.8;
const cropHeight = canvas.height * 0.2;

    const offsetX = canvas.width * 0.1;
    const offsetY = canvas.height * 0.35;
    const imageData = ctx.getImageData(offsetX, offsetY, cropWidth, cropHeight);
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = cropWidth;
    tempCanvas.height = cropHeight;
    tempCanvas.getContext("2d").putImageData(imageData, 0, 0);

    Tesseract.recognize(tempCanvas.toDataURL(), 'eng')
      .then(({ data: { text } }) => callback(text))
      .catch(() => statusP.textContent = '‚ùå L·ªói khi nh·∫≠n di·ªán.');
  }

  btnScan.addEventListener('click', async () => {
    modal.style.display = 'flex';
    statusP.textContent = 'üîÑ ƒêang kh·ªüi ƒë·ªông camera...';
    inputOCR.value = '';
    document.getElementById("ocrInput").style.display = 'block';
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      video.play();

      const track = stream.getVideoTracks()[0];
      const capabilities = track.getCapabilities();
      if (capabilities.zoom) {
        zoomContainer.style.display = 'block';
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step || 0.1;
        zoomSlider.value = capabilities.zoom.min;
        zoomSlider.addEventListener("input", () => {
          track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
        });
      }
      statusP.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi camera. Nh·∫•n "Ch·ª•p & Qu√©t" ho·∫∑c gi·ªØ ch·∫ø ƒë·ªô t·ª± ƒë·ªông';
    } catch (err) {
      statusP.textContent = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera.';
    }
  });

  btnCapture.addEventListener('click', () => {
    statusP.textContent = 'üîç ƒêang qu√©t...';
    cropCenterAndOCR((text) => {
      const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
      if (lines.length === 0) return statusP.textContent = '‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d√≤ng n√†o.';

      if (lines.length === 1) {
        inputOCR.value = lines[0];
        statusP.textContent = '‚úÖ ƒê√£ nh·∫≠n 1 d√≤ng.';
      } else {
        const selectHTML = `
          <select id="ocrLineSelector" style="width:100%; padding:8px; font-size:14px; margin-top:10px;">
            ${lines.map(l => `<option>${l}</option>`).join('')}
          </select>
        `;
        inputOCR.insertAdjacentHTML('beforebegin', selectHTML);
        const selector = document.getElementById('ocrLineSelector');
        selector.addEventListener('change', () => {
          inputOCR.value = selector.value;
        });
        inputOCR.value = lines[0];
        statusP.textContent = `‚úÖ ƒê√£ nh·∫≠n ${lines.length} d√≤ng. ƒê√£ ch·ªçn d√≤ng ƒë·∫ßu ti√™n, c√≥ th·ªÉ ch·ªânh s·ª≠a.`;
      }
    });
  });

  btnApply.addEventListener('click', () => {
    const part = inputOCR.value.trim();
    if (!part) return alert('B·∫°n ch∆∞a nh·∫≠p Part Number!');
    $('#filter-column-1').val('Part Number').trigger('change');
    $('#filter-value-1').append(new Option(part, part, true, true)).trigger('change');
    if (typeof applyFilters === 'function') applyFilters(true);
    statusP.textContent = `‚úÖ ƒê√£ l·ªçc v·ªõi Part Number: ${part}`;
    saveSearchHistory(part);
    setTimeout(() => btnClose.click(), 1500);
  });

  btnClose.addEventListener('click', () => {
    modal.style.display = 'none';
    zoomContainer.style.display = 'none';
    stopStream();
    document.getElementById("ocrLineSelector")?.remove();
    inputOCR.value = '';
  });
});
</script>
<script>
window.addEventListener('resize', () => {
  const activeEl = document.activeElement;
  if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
    setTimeout(() => {
      activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
  }
});
</script><script>
// Scroll ri√™ng cho input OCR khi focus (b√†n ph√≠m m·ªü l√™n)
document.addEventListener('DOMContentLoaded', function () {
  const ocrInput = document.getElementById('ocrInput');
  if (ocrInput) {
    ocrInput.addEventListener('focus', () => {
      setTimeout(() => {
        ocrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  }
});
</script><script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('ocrInput');
  if (input) {
    input.addEventListener('focus', () => {
      setTimeout(() => {
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  }
});
</script><script>
document.addEventListener('DOMContentLoaded', function () {
  const inputs = document.querySelectorAll('.filter-bar input, .filter-bar select');
  inputs.forEach((input) => {
    input.addEventListener('focus', () => {
      setTimeout(() => {
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
  });
});
</script>
<script>
// Spinner control
function showSpinner() {
  $('#loading-spinner').show();
}
function hideSpinner() {
  $('#loading-spinner').hide();
}

$('#apply-filters').on('click', function () {
  showSpinner();
  setTimeout(() => {
    applyFilters?.();
    hideSpinner();
  }, 100);
});

// T√¨m ki·∫øm nhanh theo Part Number
$('#quick-search').on('input', function () {
  const keyword = $(this).val().toLowerCase();
  $('#results-table tbody tr').each(function () {
    const partNumber = $(this).find('td:nth-child(2)').text().toLowerCase();
    $(this).toggle(partNumber.includes(keyword));
  });
});

// Chuy·ªÉn s·ªë Excel sang ng√†y JS
function excelDateToJSDate(serial) {
  const excelEpoch = new Date(1899, 11, 30);
  return new Date(excelEpoch.getTime() + serial * 86400000);
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const topContainer = document.querySelector('.top-container');
  const tableContainer = document.querySelector('.table-container');
  const quickSearch = document.getElementById('quick-search');
  const applyBtn = document.getElementById('apply-filters');
  const clearBtn = document.getElementById('clear-filters');

  let wasEditingTop = false;

  // G√µ trong v√πng 1 ‚Üí m·ªü r·ªông, ch∆∞a hi·ªán b·∫£ng
  document.addEventListener('focusin', (e) => {
      // B·ªè qua n·∫øu l√† m√†n h√¨nh l·ªõn (m√°y t√≠nh)
      if (window.innerWidth >= 768) return;
    const target = e.target;
    if (topContainer.contains(target) && ['INPUT', 'SELECT'].includes(target.tagName)) {
      wasEditingTop = true;
      topContainer.classList.add('full-top-container');
      topContainer.classList.remove('hide-top-container');
      tableContainer.classList.remove('show-table-only');
      quickSearch.style.display = 'none';
    } else if (target === quickSearch) {
      topContainer.classList.add('hide-top-container');
      tableContainer.classList.add('show-table-only');
    }
  });

  // Khi m·∫•t focus nh∆∞ng v·ª´a nh·∫≠p ·ªü v√πng 1 th√¨ kh√¥ng hi·ªán b·∫£ng v·ªôi
  document.addEventListener('focusout', () => {
        if (window.innerWidth >= 768) return;
    setTimeout(() => {
      const active = document.activeElement;
      if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(active.tagName)) {
        if (wasEditingTop) {
          // V·∫´n gi·ªØ v√πng top m·ªü, ch∆∞a hi·ªán b·∫£ng
          tableContainer.classList.remove('show-table-only');
          quickSearch.style.display = 'none';
        } else {
          // Quay v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
          topContainer.classList.remove('full-top-container', 'hide-top-container');
          tableContainer.classList.remove('show-table-only');
          quickSearch.style.display = 'block';
        }
      }
    }, 300);
  });

  // Khi ng∆∞·ªùi d√πng th·ª±c hi·ªán l·ªçc, m·ªõi cho ph√©p hi·ªán b·∫£ng
  function revealTableAndSearch() {
    wasEditingTop = false;
    topContainer.classList.remove('full-top-container', 'hide-top-container');
    quickSearch.style.display = 'block';
    tableContainer.classList.remove('show-table-only');
  }

  applyBtn?.addEventListener('click', revealTableAndSearch);
  clearBtn?.addEventListener('click', revealTableAndSearch);
});
</script>
<a href="/voice_search" style="position: fixed;
          bottom: 20px;
          left: 20px;
          background: #007bff;
          color: white;
          padding: 8px 10px;
          border-radius: 50%;
          font-size: 18px;
          text-decoration: none;
          box-shadow: 0 4px 10px rgba(0,0,0,0.3);
          z-index: 9999;">üé§</a>
<script>
  function saveSearchHistory(partNumber) {
    if (!partNumber) return;
    const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
    const now = new Date().toLocaleString("vi-VN");
    history.unshift({ partNumber, time: now });
    if (history.length > 30) history.pop();
    localStorage.setItem("partSearchHistory", JSON.stringify(history));
    renderSearchHistory();
  }

  function renderSearchHistory() {
    const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
    const list = document.getElementById("searchHistory");
    if (!list) return;
    list.innerHTML = "";
    history.forEach(item => {
      const li = document.createElement("li");
      li.style.marginBottom = "6px";
      li.innerHTML = `<button onclick="quickSearchFromHistory('${item.partNumber}'); navigator.clipboard.writeText('${item.partNumber}')" title="Click ƒë·ªÉ tra c·ª©u v√† sao ch√©p" style="background:#444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">${item.partNumber}</button> <small style="color:#ccc;">(${item.time})</small>`;
      list.appendChild(li);
    });
  }

  
  function quickSearchFromHistory(partNumber) {
    // G√°n v√†o b·ªô l·ªçc ti√™u ch√≠ s·ªë 1
    const col1 = document.getElementById("filter-column-1");
    const val1 = document.getElementById("filter-value-1");
    if (col1 && val1) {
      col1.value = "Part Number";
      col1.dispatchEvent(new Event("change")); // c·∫≠p nh·∫≠t select2 n·∫øu c√≥
      setTimeout(() => {
        if ($(val1).data('select2')) {
          $(val1).val([partNumber]).trigger("change");
        } else {
          val1.value = partNumber;
        }
        // G·ªçi l·ªçc
        applyFilters(true);
      }, 100);
    }
  }

  function clearSearchHistory() {
    localStorage.removeItem("partSearchHistory");
    renderSearchHistory();
  }

  window.addEventListener("DOMContentLoaded", renderSearchHistory);
</script>
<!-- üìú L·ªãch s·ª≠ n·ªïi Part Number -->
<!-- üìú N√∫t m·ªü popup + Popup l·ªãch s·ª≠ -->
<button onclick="toggleHistoryPopup()" style="position: fixed; bottom: 20px; left: 20px; background: #00cc99; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 20px; cursor: pointer; z-index: 9999;" title="L·ªãch s·ª≠ t√¨m ki·∫øm">üïò</button>
<div id="floating-history-popup" style="display: none; position: fixed; bottom: 80px; left: 20px; background: rgba(30,30,30,0.95); color: white; padding: 16px; border-radius: 12px; width: 300px; max-height: 360px; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 9999;">
<div style="display: flex; justify-content: space-between; align-items: center;">
<h4 style="margin: 0;">üìú L·ªãch s·ª≠ t√¨m ki·∫øm</h4>
<button onclick="toggleHistoryPopup()" style="background: transparent; color: white; border: none; font-size: 20px; cursor: pointer;">√ó</button>
</div>
<ul id="searchHistory" style="list-style: none; padding-left: 0; margin: 12px 0;"></ul>
<button onclick="clearSearchHistory()" style="margin-top: 8px; background:#cc4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width:100%;">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
</div>

<!-- üîä N√∫t chuy·ªÉn sang trang voice -->
<a href="/voice_search" style="position: fixed; bottom: 20px; right: 20px; background: #0066ff; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; text-decoration: none; z-index: 9999;" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
  üé§
</a>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const historyList = document.getElementById("history-list");
    const storedHistory = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");


    if (storedHistory.length > 0) {
        storedHistory.forEach(item => {
            const div = document.createElement("div");
            div.className = "text-white px-3";
            div.textContent = "üîç " + item;
            historyList.appendChild(div);
        });
    } else {
        const emptyMsg = document.createElement("div");
        emptyMsg.className = "text-gray-400 px-3";
        emptyMsg.textContent = "Kh√¥ng c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm.";
        historyList.appendChild(emptyMsg);
    }

    document.getElementById("clear-history-btn").addEventListener("click", function () {
        localStorage.removeItem("partSearchHistory");
        location.reload();
    });
});
</script>
</body></html>
<script>
function toggleHistoryPopup() {
  const popup = document.getElementById("floating-history-popup");
  if (popup) {
    const isOpen = popup.style.display === "block";
    popup.style.display = isOpen ? "none" : "block";

    if (!isOpen) {
      renderSearchHistory(); // G·ªçi l·∫°i ƒë·ªÉ load m·ªõi l·ªãch s·ª≠
    }
  }
}

</script>
