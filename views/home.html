<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Web Tra C·ª©u - Nguy·ªÖn VƒÉn ƒê·∫°o</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        /* ƒêo·∫°n CSS responsive m√°y t√≠nh */
        @media (min-width: 768px) {
          html, body {
            height: 100%;
            overflow: hidden;
          }

          body {
            overflow-y: auto;
          }

          input, select, textarea {
            touch-action: manipulation;
            -webkit-user-select: text;
            user-select: text;
            caret-color: auto;
          }

          input:focus,
          select:focus,
          textarea:focus {
            outline: none;
            box-shadow: none;
          }
        }
        /* C√†i ƒë·∫∑t CSS c∆° b·∫£n */
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
          font-family: Arial, sans-serif;
          background: url('background.jpg') no-repeat center center/cover;
          color: #333;
          display: flex;
          flex-direction: column;
        }
        .page-container {
          display: flex;
          flex-direction: column;
          height: 100%;
        }
        .top-container {
          flex: 0 0 auto;
          background: rgba(0, 0, 0, 0.85);
          padding: 15px;
          max-height: 40vh;
          overflow-y: auto;
          position: relative;
        }
        .header {
          text-align: center;
          padding: 10px;
          position: relative;
        }
        .tasks-link {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            background: #007bff;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease-out; /* M∆∞·ª£t h∆°n */
        }
        .tasks-link:hover {
            background: #0056b3;
            transform: translateY(-2px) scale(1.01); /* Th√™m hi·ªáu ·ª©ng hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .tasks-link:active {
            transform: translateY(1px) scale(0.99); /* Th√™m hi·ªáu ·ª©ng active */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .header h1 { margin: 0; font-size: 28px; color: white; }
        .header p { margin: 5px 0 0; font-size: 16px; color: #ddd; }
        /* Language switcher ·ªü g√≥c tr√™n b√™n ph·∫£i */
        .language-switcher {
          position: absolute;
          top: 10px;
          right: 10px;
        }
        .language-switcher button {
          padding: 4px 8px;
          margin-left: 5px;
          font-size: 12px;
          cursor: pointer;
          border: none;
          border-radius: 3px;
          background: #ff8c00;
          color: white;
          transition: all 0.3s ease-out; /* M∆∞·ª£t h∆°n */
        }
        .language-switcher button:hover {
          background: #ff6500;
          transform: translateY(-2px) scale(1.01); /* Th√™m hi·ªáu ·ª©ng hover */
          box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .language-switcher button:active {
            transform: translateY(1px) scale(0.99); /* Th√™m hi·ªáu ·ª©ng active */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Kh·ªëi ch·ª©a c√°c ti√™u ch√≠ l·ªçc */
        .filter-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          padding: 5px;
        }
        .filter-block {
          background: #444;
          border-radius: 5px;
          padding: 5px;
          margin: 5px;
          width: 220px; /* TƒÉng chi·ªÅu r·ªông ƒë·ªÉ ch·ª©a 2 date input */
          font-size: 12px;
          color: white;
          box-sizing: border-box;
        }
        .filter-block label {
          display: block;
          margin-bottom: 3px;
          font-weight: bold;
        }
        .filter-block select, .filter-block input[type="date"] {
          width: 100%;
          padding: 3px;
          margin-bottom: 3px;
          font-size: 12px;
          box-sizing: border-box;
          border-radius: 3px;
          border: 1px solid #666;
        }
        .filter-block input[type="date"] {
            background-color: #fff;
            color: #333;
        }
        .date-range-inputs {
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .date-range-inputs label {
            font-size: 10px;
            margin-top: 5px;
            margin-bottom: 1px;
        }


        /* Kh·ªëi ch·ª©a c√°c n√∫t ch·ª©c nƒÉng */
        .action-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          padding: 5px;
        }
        .action-bar > div {
          background: #444;
          border-radius: 5px;
          padding: 5px;
          margin: 5px;
          font-size: 12px;
          color: white;
          text-align: center;
        }
        .action-bar button {
          padding: 6px 12px;
          font-size: 12px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.3s ease-out; /* M∆∞·ª£t h∆°n */
          margin: 3px;
        }
        .action-bar button:hover {
            transform: translateY(-2px) scale(1.01); /* Th√™m hi·ªáu ·ª©ng hover */
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .action-bar button:active {
            transform: translateY(1px) scale(0.99); /* Th√™m hi·ªáu ·ª©ng active */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .filter-actions button {
          background: linear-gradient(45deg, #ff8c00, #ff4500);
          color: white;
        }
        .filter-actions button:hover {
          background: linear-gradient(45deg, #ff6500, #ff0000);
        }
        .download-container button {
          background: linear-gradient(45deg, #007bff, #0056b3);
          color: white;
        }
        .download-container button:hover {
          background: linear-gradient(45deg, #3399ff, #007bff);
        }
        .zoom-controls button {
          background: linear-gradient(45deg, #28a745, #218838);
          color: white;
        }
        .zoom-controls button:hover {
          background: linear-gradient(45deg, #34d058, #28a745);
        }
        /* Ph·∫ßn hi·ªÉn th·ªã t·ªïng s·ªë d√≤ng */
        .results-count {
          text-align: center;
          margin: 5px;
          font-size: 14px;
          color: white;
        }
        /* B·∫£ng d·ªØ li·ªáu */
        .table-container {
          flex: 1 1 auto;
          margin: 5px auto;
          width: 98%;
          max-height: calc(100vh - 260px); /* ƒêi·ªÅu ch·ªânh n·∫øu top-container thay ƒë·ªïi chi·ªÅu cao */
          overflow-y: auto;
          overflow-x: auto;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 5px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        table {
          width: auto; /* Cho ph√©p b·∫£ng co gi√£n theo n·ªôi dung */
          min-width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng chi·∫øm √≠t nh·∫•t to√†n b·ªô chi·ªÅu r·ªông container */
          border-collapse: collapse;
          table-layout: fixed; /* Gi√∫p c·ªôt c·ªë ƒë·ªãnh ho·∫°t ƒë·ªông t·ªët h∆°n */
        }
        th, td {
          padding: 6px 8px;
          border: 1px solid #ccc;
          font-size: 12px;
          text-align: center;
          white-space: nowrap;
        }
        th {
          background: #4a76a8;
          color: white;
          position: sticky;
          top: 0;
          z-index: 2;
        }
        .sticky-col-1 {
          position: sticky;
          left: 0;
          width: 40px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho c·ªôt No */
          min-width: 40px;
          background: #4a76a8; /* M√†u n·ªÅn gi·ªëng th */
          z-index: 3; /* Cao h∆°n th th∆∞·ªùng v√† td th∆∞·ªùng */
        }
        .sticky-col-2 {
          position: sticky;
          left: 40px; /* No (40px) */
          width: 100px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho Part Number */
          min-width: 100px;
          background: #4a76a8;
          z-index: 3;
        }
        .sticky-col-3 {
          position: sticky;
          left: 140px; /* No (40px) + Part Number (100px) */
          width: 50px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho REV */
          min-width: 50px;
          background: #4a76a8;
          z-index: 3;
        }
        td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
          background: #e6e6e6; /* M√†u n·ªÅn kh√°c cho td c·ªë ƒë·ªãnh ƒë·ªÉ ph√¢n bi·ªát */
          color: #333;
          z-index: 1; /* Cao h∆°n td th∆∞·ªùng nh∆∞ng th·∫•p h∆°n th c·ªë ƒë·ªãnh */
        }
        tr.selected { background-color: #ffeb99 !important; }
        .footer {
          flex: 0 0 auto;
          text-align: center;
          padding: 5px;
          font-size: 14px;
          background: #333;
          color: white;
        }

        /* CSS cho popup ·∫£nh */
        #image-popup {
            display: none;
            position: fixed;
            border: 1px solid #ccc;
            background: white;
            padding: 5px;
            z-index: 10000;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            max-width: 400px; /* TƒÉng k√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh */
            max-height: 400px; /* TƒÉng k√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh */
            cursor: default;
            transition: all 0.3s ease-in-out;
            overflow: auto; /* Cho ph√©p cu·ªôn khi ·∫£nh l·ªõn h∆°n popup ƒë√£ zoom */
        }
        #image-popup img {
            max-width: 100%;
            max-height: 100%;
            display: block; /* Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a d∆∞·ªõi ·∫£nh */
            cursor: zoom-in; /* Con tr·ªè ban ƒë·∫ßu */
            object-fit: contain; /* ƒê·∫£m b·∫£o ·∫£nh lu√¥n v·ª´a v·∫∑n */
            width: 100%; 
            height: 100%;
        }
        
        #image-popup .no-image-text {
            padding: 10px;
            text-align: center;
            color: #555;
        }

        /* Class cho tr·∫°ng th√°i ph√≥ng to */
        #image-popup.zoomed {
            max-width: 90vw; /* Chi·∫øm 90% chi·ªÅu r·ªông viewport */
            max-height: 90vh; /* Chi·∫øm 90% chi·ªÅu cao viewport */
            width: auto;  /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông theo n·ªôi dung ·∫£nh */
            height: auto; /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu cao theo n·ªôi dung ·∫£nh */
            padding: 15px; /* TƒÉng padding khi zoom */
        }

        #image-popup.zoomed img {
            cursor: zoom-out; /* ƒê·ªïi cursor khi ·∫£nh ƒë√£ ƒë∆∞·ª£c ph√≥ng to */
        }

        /* N√∫t ƒë√≥ng (X) */
        .image-popup-close {
            position: absolute;
            top: 0px; 
            right: 8px;
            font-size: 24px; 
            font-weight: bold;
            cursor: pointer;
            color: #333;
            z-index: 10001; 
            padding: 2px 5px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 50%;
            line-height: 1;
        }
        .image-popup-close:hover {
            color: #000;
            background-color: rgba(255,255,255,0.9);
        }

        /* CSS cho spinner t·∫£i ·∫£nh trong popup */
        .image-popup-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* ·∫®n ban ƒë·∫ßu */
            z-index: 10002; /* Tr√™n ·∫£nh */
        }

        @media (max-width: 768px) {
          .language-switcher {
            position: static;
            margin-top: 10px;
            text-align: center;
          }
          .language-switcher button {
            padding: 3px 6px;
            margin: 0 3px;
            font-size: 10px;
          }
          .filter-bar, .action-bar {
            flex-direction: column;
            align-items: stretch;
          }
          .filter-block, .action-bar > div {
            width: 90%; /* TƒÉng chi·ªÅu r·ªông cho d·ªÖ thao t√°c */
            margin: 5px auto;
          }
          .header h1 { font-size: 24px; }
          .header p { font-size: 14px; }
          table, th, td { font-size: 10px; }
          .table-container {
            max-height: calc(100vh - 320px); /* ƒêi·ªÅu ch·ªânh n·∫øu c·∫ßn */
          }
           .top-container {
                max-height: 45vh !important; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa cho v√πng filter */
                padding: 8px !important;
                overflow-y: auto;
            }
            .action-bar button,
            .language-switcher button {
                font-size: 16px; /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ cho n√∫t */
                padding: 10px 16px; /* TƒÉng padding cho n√∫t */
            }
             #quick-search {
                font-size: 13px !important; /* ƒê·∫£m b·∫£o quick search d·ªÖ th·∫•y */
            }
        }
        @media (max-width: 480px) {
          .tasks-link {
            position: relative;
            top: 0;
            left: 0;
            display: block;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            font-size: 16px;
          }
          .header h1 { font-size: 20px; }
          .header p { font-size: 12px; }
          table, th, td { font-size: 9px; }
        }

        @media (max-width: 768px) {
          body {
            padding-bottom: 300px; /* ch·ª´a ch·ªó cho b√†n ph√≠m */
          }
        }

        @media screen and (orientation: landscape), (orientation: portrait) {
          .table-container {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
            touch-action: pan-y; /* Cho ph√©p cu·ªôn d·ªçc b·∫±ng c·∫£m ·ª©ng */
          }
          table {
            width: auto;
            min-width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng chi·∫øm √≠t nh·∫•t to√†n b·ªô chi·ªÅu r·ªông */
          }
          td, th {
            word-break: break-word; /* Cho ph√©p ng·∫Øt t·ª´ n·∫øu c·∫ßn */
          }
        }

        /* T·ªëi ∆∞u b·∫£ng cho ƒëi·ªán tho·∫°i xoay ngang/d·ªçc v√† khi m·ªü b√†n ph√≠m */
        .table-container {
          width: 100vw; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông viewport */
          max-height: 50vh; /* Chi·ªÅu cao t·ªëi ƒëa */
          overflow-x: auto;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch; /* Cu·ªôn m∆∞·ª£t tr√™n iOS */
          scroll-behavior: smooth;
          touch-action: auto; /* Cho ph√©p c·∫£ cu·ªôn ngang v√† d·ªçc */
        }

        @media screen and (orientation: landscape) {
          .table-container {
            max-height: 60vh;
          }
        }

        @media screen and (orientation: portrait) {
          .table-container {
            max-height: 50vh;
          }
        }

        table {
          min-width: 800px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu c·ªßa b·∫£ng, ƒëi·ªÅu ch·ªânh n·∫øu c·∫ßn */
        }

        th, td {
          word-break: break-word;
          white-space: nowrap;
        }

        .table-container {
            width: 100%; /* ƒê·∫£m b·∫£o container chi·∫øm to√†n b·ªô chi·ªÅu r·ªông cha */
            overflow-x: auto;
            overflow-y: auto;
            max-height: 60vh; /* Ho·∫∑c gi√° tr·ªã ph√π h·ª£p */
            -webkit-overflow-scrolling: touch;
        }
        table {
            border-collapse: collapse;
            min-width: 1000px; /* Ho·∫∑c gi√° tr·ªã ph√π h·ª£p v·ªõi s·ªë c·ªôt */
        }
        th, td {
            white-space: nowrap; /* Gi·ªØ n·ªôi dung tr√™n m·ªôt d√≤ng */
            padding: 6px; /* ƒêi·ªÅu ch·ªânh padding n·∫øu c·∫ßn */
            font-size: 12px;
        }
        .sticky-col-1 {
            position: sticky; left: 0; background: #4a76a8; z-index: 3;
        }
        .sticky-col-2 {
            position: sticky; left: 40px; background: #4a76a8; z-index: 3;
        }
        .sticky-col-3 {
            position: sticky; left: 140px; background: #4a76a8; z-index: 3;
        }
        td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
            background: #f3f3f3; /* M√†u n·ªÅn s√°ng h∆°n cho td c·ªë ƒë·ªãnh */
        }

        /* --- C·∫£i ti·∫øn cho input khi focus --- */
        input:focus, select:focus {
          outline: 2px solid #ff8c00; /* Vi·ªÅn cam n·ªïi b·∫≠t khi focus */
          background-color: #fffce6; /* N·ªÅn v√†ng nh·∫°t khi focus */
        }

        /* TƒÉng font input tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ d·ªÖ nh·∫≠p */
        @media (max-width: 768px) {
          input, select {
            font-size: 16px; /* K√≠ch th∆∞·ªõc ch·ªØ l·ªõn h∆°n cho input tr√™n mobile */
          }
        }

        /* C·∫£i thi·ªán b·∫£ng khi xoay ngang */
        @media screen and (orientation: landscape) {
            .top-container {
                max-height: 30vh; /* Gi·∫£m chi·ªÅu cao v√πng filter khi xoay ngang */
                overflow-y: auto;
            }
            .table-container {
                height: auto; /* Cho ph√©p b·∫£ng t·ª± ƒëi·ªÅu ch·ªânh chi·ªÅu cao */
                max-height: 90vh; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa cho b·∫£ng */
                min-height: 70vh; /* Chi·ªÅu cao t·ªëi thi·ªÉu cho b·∫£ng */
                overflow-x: auto;
                overflow-y: auto;
            }
            table {
                min-width: 1200px; /* TƒÉng chi·ªÅu r·ªông t·ªëi thi·ªÉu c·ªßa b·∫£ng khi xoay ngang */
            }
        }


        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        #results-table td, #results-table th {
          user-select: text; /* Cho ph√©p ch·ªçn vƒÉn b·∫£n trong b·∫£ng */
        }

        /* Hi·ªáu ·ª©ng n·ªïi b·∫≠t h√†ng khi di chu·ªôt */
        #results-table tbody tr {
            transition: background-color 0.2s ease-in-out; /* Ch·ªâ chuy·ªÉn ƒë·ªïi m√†u n·ªÅn */
        }
        #results-table tbody tr:hover {
            background-color: #e0e0e0; /* M√†u n·ªÅn khi hover */
            /* ƒê√£ lo·∫°i b·ªè transform v√† box-shadow */
        }
        /* ƒê·∫£m b·∫£o c√°c c·ªôt sticky v·∫´n c√≥ m√†u n·ªÅn ph√π h·ª£p khi hover */
        #results-table tbody tr:hover td.sticky-col-1,
        #results-table tbody tr:hover td.sticky-col-2,
        #results-table tbody tr:hover td.sticky-col-3 {
            background-color: #d0d0d0; /* M√†u n·ªÅn cho sticky cells khi hover */
        }


        @media (max-width: 768px) {
            .top-container {
                max-height: 40vh !important; /* Quan tr·ªçng: ƒê·∫£m b·∫£o ghi ƒë√® c√°c style kh√°c */
                padding: 8px !important;
                overflow-y: auto;
            }

            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }

            .filter-block,
            .action-bar > div {
                padding: 4px;
                margin: 3px;
                font-size: 11px;
            }

            .action-bar button,
            .language-switcher button {
                font-size: 16px; /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ cho n√∫t */
                padding: 10px 16px; /* TƒÉng padding cho n√∫t */
            }

            .filter-block select {
                font-size: 12px;
            }

            .results-count {
                font-size: 12px;
            }

            #quick-search {
                font-size: 13px !important; /* ƒê·∫£m b·∫£o quick search d·ªÖ th·∫•y */
            }
        }


        /* Hi·ªáu ·ª©ng m∆∞·ª£t cho v√πng ƒë·ªông */
        .top-container,
        .table-container,
        #quick-search {
          transition: all 0.3s ease-in-out;
        }
        .full-top-container {
          height: 100vh !important;
          max-height: 100vh !important;
          overflow-y: auto;
        }
        .hide-top-container {
          height: 0 !important;
          max-height: 0 !important;
          overflow: hidden;
          padding: 0 !important;
          opacity: 0;
          pointer-events: none;
        }
        .show-table-only {
          height: calc(100vh - 60px); /* 60px l√† chi·ªÅu cao c·ªßa quick search v√† footer */
        }

        /* Style cho th√¥ng b√°o sao ch√©p */
        .copy-feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            font-size: 16px;
            opacity: 0; /* B·∫Øt ƒë·∫ßu ·∫©n */
            transition: opacity 0.5s ease-out; /* Hi·ªáu ·ª©ng m·ªù d·∫ßn */
            pointer-events: none; /* Kh√¥ng ch·∫∑n click chu·ªôt */
        }
        .copy-feedback-message.show {
            opacity: 1; /* Hi·ªÉn th·ªã */
        }

    </style>
</head>
<body>
    <div id="loading-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999;">
        <div style="border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>

    <div class="page-container">
        <div class="top-container">
            <div class="header">
                <a class="tasks-link" href="/tasks">Tasks</a>
                <h1 id="header-title">FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR</h1>
                <p id="header-subtitle">Tra c·ª©u t√¨nh tr·∫°ng FAIR</p>
                <div class="language-switcher">
                    <button onclick="changeLanguage('vi')">Vi</button>
                    <button onclick="changeLanguage('en')">En</button>
                    <button onclick="changeLanguage('ko')">Ko</button>
                </div>
            </div>

            <div class="filter-bar">
                <div class="filter-block" id="filter-block-project">
                    <label for="filter-project" id="label-filter-project">Ch·ªçn d·ª± √°n (Customer)</label>
                    <select class="value-select" id="filter-project" multiple="multiple"></select>
                </div>
                <div class="filter-block" id="filter-block-1">
                    <label for="filter-column-1" id="label-criteria-1">Ch·ªçn ti√™u ch√≠ s·ªë 1:</label>
                    <select id="filter-column-1">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</sCRIPT>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-1" id="label-filter-value-1">Ch·ªçn gi√° tr·ªã</label>
                    <select class="value-select" id="filter-value-1" multiple="multiple"></select>
                    <div class="date-range-inputs" id="date-range-1">
                        <label for="filter-date-start-1">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-1">
                        <label for="filter-date-end-1">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-1">
                    </div>
                </div>
                <div class="filter-block" id="filter-block-2">
                    <label for="filter-column-2" id="label-criteria-2">Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):</label>
                    <select id="filter-column-2">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</sCRIPT>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-2" id="label-filter-value-2">Ch·ªçn gi√° tr·ªã</label>
                    <select id="filter-value-2" multiple="multiple"></select>
                     <div class="date-range-inputs" id="date-range-2">
                        <label for="filter-date-start-2">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-2">
                        <label for="filter-date-end-2">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-2">
                    </div>
                </div>
                <div class="filter-block" id="filter-block-3">
                    <label for="filter-column-3" id="label-criteria-3">Ch·ªçn ti√™u ch√≠ s·ªë 3:</label>
                    <select id="filter-column-3">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-3" id="label-filter-value-3">Ch·ªçn gi√° tr·ªã</label>
                    <select class="value-select" id="filter-value-3" multiple="multiple"></select>
                    <div class="date-range-inputs" id="date-range-3">
                        <label for="filter-date-start-3">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-3">
                        <label for="filter-date-end-3">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-3">
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <div class="filter-actions">
                    <button id="apply-filters">√Åp D·ª•ng L·ªçc</button>
                    <button id="clear-filters">X√≥a L·ªçc</button>
                </div>
                <div class="download-container">
                    <button id="download-excel">Xu·∫•t Excel (ƒêang xem)</button>
                    <button id="export-all">Xu·∫•t Excel (T·∫•t c·∫£)</button>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-in">Ph√≥ng to</button>
                    <button id="zoom-out">Thu nh·ªè</button>
                </div>
            </div>
            <div class="scan-camera" style="text-align:center; margin-top:10px;">
                <button id="btnScanCamera" style="transition: all 0.3s ease-out;">üì∑ Qu√©t Camera</button>
            </div>
            <div class="results-count" id="results-count">Total rows: 0</div>
        </div>

        <div style="text-align:center; margin: 10px;">
            <input id="quick-search" placeholder="üîç T√¨m Part Number..." style="padding:5px; width: 60%; font-size:14px;" type="text"/>
        </div>

        <div class="table-container">
            <table id="results-table">
                <thead><tr>
                    <th class="sticky-col-1" data-column="No">No</th>
                    <th class="sticky-col-2" data-column="Part Number">Part Number</th>
                    <th class="sticky-col-3" data-column="REV">REV</th>
                    <th data-column="Approval Status">Approval Status</th>
                    <th data-column="Customer">Customer</th>
                    <th data-column="Commodity">Commodity</th>
                    <th data-column="Production Status">Production Status</th>
                    <th data-column="Part Pictures">Part Pictures</th>
                    <th data-column="Packaging Pictures">Packaging Pictures</th>
                    <th data-column="Critical">Critical</th>
                    <th data-column="CE">CE</option>
                    <th data-column="PO Number">PO Number</option>
                    <th data-column="Description">Description</option>
                    <th data-column="ERP-CODE">ERP-CODE</option>
                    <th data-column="Note Number">Note Number</option>
                    <th data-column="PO received date">PO received date</option>
                    <th data-column="Customer need date">Customer need date</option>
                    <th data-column="Requirements">Requirements</option>
                    <th data-column="FAIR Cover sheet">FAIR Cover sheet</option>
                    <th data-column="Bubble Drawings">Bubble Drawings</option>
                    <th data-column="Datasheet form">Datasheet form</option>
                    <th data-column="LAIR Data">LAIR Data</option>
                    <th data-column="FAIR Data">FAIR Data</option>
                    <th data-column="COC">COC</option>
                    <th data-column="BOM">BOM</option>
                    <th data-column="Mill">Mill</option>
                    <th data-column="Test reports / evidences">Test reports / evidences</option>
                    <th data-column="Remark 1">Remark 1</option>
                    <th data-column="Remark 2">Remark 2</option>
                    <th data-column="Submit date">Submit date</option>
                    <th data-column="Reject comments">Reject comments</option>
                </tr></thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="load-more-container" style="text-align:center; margin:10px;">
            <button id="load-more">Load More</button>
            <button id="load-all">Load All</button>
        </div>
        <div class="footer" id="footer-text">Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o</div>
    </div>

    <div id="image-popup"> <span class="image-popup-close">&times;</span> <div class="image-popup-spinner"></div> <img src="" alt="Part Image" style="display:none;"> <span class="no-image-text" style="display:none;"></span>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>

    <script>
        // Kh·ªüi t·∫°o i18next
        i18next.use(i18nextBrowserLanguageDetector).init({
          fallbackLng: 'vi',
          debug: false,
          resources: {
            en: {
              translation: {
                "header_title": "FAIR TEAM - Search Status",
                "header_subtitle": "Search FAIR status",
                "choose_project": "Choose Project",
                "choose_value": "Choose Value",
                "choose_criteria_1": "Select Criteria 1:",
                "choose_criteria_2": "Select Criteria 2 (paste excel):",
                "choose_criteria_3": "Select Criteria 3:",
                "apply_filter": "Apply Filter",
                "clear_filter": "Clear Filter",
                "download_excel": "Export Excel (Current)",
                "export_all": "Export Excel (All)",
                "zoom_in": "Zoom In",
                "zoom_out": "Zoom Out",
                "load_more": "Load More",
                "load_all": "Load All",
                "total_rows": "Total rows: {{count}} / {{total}}",
                "developer": "Developer: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "From Date:",
                "date_to": "To Date:",
                "no_image_found": "No image found for Part Number \"{{partNumber}}\" (ERP: {{erpCode}}).",
                "no_erp_code": "No image for Part Number \"{{partNumber}}\". (Missing ERP-CODE)"
              }
            },
            ko: {
              translation: {
                "header_title": "FAIR TEAM - Í≤ÄÏÉâ ÏÉÅÌÉú",
                "header_subtitle": "FAIR ÏÉÅÌÉú Í≤ÄÏÉâ",
                "choose_project": "ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù",
                "choose_value": "Í∞í ÏÑ†ÌÉù",
                "choose_criteria_1": "Í∏∞Ï§Ä 1 ÏÑ†ÌÉù:",
                "choose_criteria_2": "Í∏∞Ï§Ä 2 ÏÑ†ÌÉù (ÏóëÏÖÄ Î∂ôÏó¨ÎÑ£Í∏∞):",
                "choose_criteria_3": "Í∏∞Ï§Ä 3 ÏÑ†ÌÉù:",
                "apply_filter": "ÌïÑÌÑ∞ Ï†ÅÏö©",
                "clear_filter": "ÌïÑÌÑ∞ ÏßÄÏö∞Í∏∞",
                "download_excel": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌòÑÏû¨ Î≥¥Í∏∞)",
                "export_all": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Ï†ÑÏ≤¥)",
                "zoom_in": "ÌôïÎåÄ",
                "zoom_out": "Ï∂ïÏÜå",
                "load_more": "Îçî Î∂àÎü¨Ïò§Í∏∞",
                "load_all": "Ï†ÑÏ≤¥ Î∂àÎü¨Ïò§Í∏∞",
                "total_rows": "Ï¥ù Ìñâ: {{count}} / {{total}}",
                "developer": "Í∞úÎ∞úÏûê: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "ÏãúÏûë ÎÇ†Ïßú:",
                "date_to": "Ï¢ÖÎ£å ÎÇ†Ïßú:",
                "no_image_found": "Î∂ÄÌíà Î≤àÌò∏ \"{{partNumber}}\" (ERP: {{erpCode}})Ïóê ÎåÄÌïú Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.",
                "no_erp_code": "Î∂ÄÌíà Î≤àÌò∏ \"{{partNumber}}\"Ïóê ÎåÄÌïú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. (ERP-CODE ÎàÑÎùΩ)"
              }
            },
            vi: {
              translation: {
                "header_title": "FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR",
                "header_subtitle": "Tra c·ª©u t√¨nh tr·∫°ng FAIR",
                "choose_project": "Ch·ªçn d·ª± √°n",
                "choose_value": "Ch·ªçn gi√° tr·ªã",
                "choose_criteria_1": "Ch·ªçn ti√™u ch√≠ s·ªë 1:",
                "choose_criteria_2": "Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):",
                "choose_criteria_3": "Ch·ªçn ti√™u ch√≠ s·ªë 3:",
                "apply_filter": "√Åp d·ª•ng l·ªçc",
                "clear_filter": "X√≥a l·ªçc",
                "download_excel": "Xu·∫•t Excel (ƒêang xem)",
                "export_all": "Xu·∫•t Excel (T·∫•t c·∫£)",
                "zoom_in": "Ph√≥ng to",
                "zoom_out": "Thu nh·ªè",
                "load_more": "T·∫£i th√™m",
                "load_all": "T·∫£i to√†n b·ªô",
                "total_rows": "T·ªïng s·ªë d√≤ng: {{count}} / {{total}}",
                "developer": "Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "T·ª´ ng√†y:",
                "date_to": "ƒê·∫øn ng√†y:",
                "no_image_found": "·∫¢nh cho Part Number \"{{partNumber}}\" (ERP: {{erpCode}}) kh√¥ng t·ªìn t·∫°i.",
                "no_erp_code": "Kh√¥ng c√≥ ·∫£nh cho Part Number \"{{partNumber}}\". (Thi·∫øu ERP-CODE)"
              }
            }
          }
        }, function(err, t) {
          updateStaticContent();
        });

        function reinitializeSelect2(selector, placeholder, extraOptions) {
          var $el = $(selector);
          var currentValue = $el.val();
          if ($el.data('select2')) { 
            $el.select2("destroy");
          }
          $el.select2($.extend({
            placeholder: placeholder,
            allowClear: true,
            width: '100%'
          }, extraOptions));
          if(currentValue) { 
            $el.val(currentValue).trigger('change.select2'); 
          }
        }

        function updateStaticContent() {
          document.getElementById("header-title").innerText = i18next.t("header_title");
          document.getElementById("header-subtitle").innerText = i18next.t("header_subtitle");
          var labelSheet = document.querySelector('label[for="filter-project"]');
          if (labelSheet) { labelSheet.innerText = i18next.t("choose_project"); }
          
          for (let i = 1; i <= 3; i++) {
            var labelCriteria = document.getElementById(`label-criteria-${i}`);
            if (labelCriteria) { labelCriteria.innerText = i18next.t(`choose_criteria_${i}`); }
            
            var labelValue = document.getElementById(`label-filter-value-${i}`);
            if (labelValue) { labelValue.innerText = i18next.t("choose_value"); }

            var labelDateFrom = $(`#date-range-${i} label[for="filter-date-start-${i}"]`);
            if (labelDateFrom.length) { labelDateFrom.text(i18next.t("date_from")); }
            var labelDateTo = $(`#date-range-${i} label[for="filter-date-end-${i}"]`);
            if (labelDateTo.length) { labelDateTo.text(i18next.t("date_to")); }
          }
          
          var tbodyCount = $('#results-table tbody').children().length;
          $('#results-count').text(i18next.t("total_rows", { count: tbodyCount, total: totalData }));

          reinitializeSelect2('#filter-project', i18next.t("choose_project"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-1', i18next.t("choose_value"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-2', i18next.t("choose_value"), {});
          reinitializeSelect2('#filter-value-3', i18next.t("choose_value"), { closeOnSelect: false });

          document.getElementById("apply-filters").innerText = i18next.t("apply_filter");
          document.getElementById("clear-filters").innerText = i18next.t("clear_filter");
          document.getElementById("download-excel").innerText = i18next.t("download_excel");
          document.getElementById("export-all").innerText = i18next.t("export_all");
          document.getElementById("zoom-in").innerText = i18next.t("zoom_in");
          document.getElementById("zoom-out").innerText = i18next.t("zoom_out");
          document.getElementById("load-more").innerText = i18next.t("load_more");
          document.getElementById("load-all").innerText = i18next.t("load_all");
          document.getElementById("footer-text").innerText = i18next.t("developer");
        }

        function changeLanguage(lng) {
          i18next.changeLanguage(lng, function() {
            updateStaticContent();
            $('.value-select').each(function() {
                const placeholderText = $(this).attr('id') === 'filter-project' ? i18next.t("choose_project") : i18next.t("choose_value");
                $(this).data('select2').$container.find('.select2-selection__placeholder').text(placeholderText);
            });
          });
        }
    </script>
    <script>
        function formatExcelDate(val) {
            if (!val) return '';
            if (typeof val === 'number') {
                let date = new Date(Date.UTC(1899, 11, 30 + val)); 
                if (!isNaN(date)) {
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } else if (typeof val === 'string') {
                const parsed = new Date(val);
                if (!isNaN(parsed)) {
                    const year = parsed.getFullYear(); 
                    const month = String(parsed.getMonth() + 1).padStart(2, '0');
                    const day = String(parsed.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            return val; 
        }

        let currentFilters = {};
        let currentOffset = 0;
        const pageSize = 50;
        let totalData = 0;
        let currentZoom = 1;
        let allData = null;

        // --- C√ÅC BI·∫æN THAM CHI·∫æU POPUP ·∫¢NH (KHAI B√ÅO M·ªòT L·∫¶N) ---
        const imagePopup = $('#image-popup');
        const popupImg = imagePopup.find('img');
        const popupText = imagePopup.find('span.no-image-text');
        const popupCloseButton = imagePopup.find('.image-popup-close');
        const popupSpinner = imagePopup.find('.image-popup-spinner'); // Spinner m·ªõi


        function loadAllData() {
          $.getJSON('/search?limit=1000000', function(response) { 
            allData = response.data;
            totalData = response.total;
            updateFilterValuesForBlock(1);
            updateCascade(2); 
          });
        }

        function loadDistinctValuesForProject() {
          const selectElem = $('#filter-project');
          selectElem.empty();
          $.getJSON('/filters', function(data) {
            if (data['Customer']) {
              data['Customer'].forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
              });
            }
            selectElem.trigger('change');
          });
        }

        function handleFilterTypeChange(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const valueSelectContainer = $('#filter-value-' + blockIndex).next('.select2-container');
            const valueSelect = $('#filter-value-' + blockIndex);
            const dateRangeInputs = $(`#date-range-${blockIndex}`);
            const labelValue = $(`label[for="filter-value-${blockIndex}"]`);

            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            if (selectedOptionDataType === 'date') {
                valueSelectContainer.hide();
                valueSelect.hide();
                dateRangeInputs.show();
                labelValue.hide(); 
            } else {
                dateRangeInputs.hide();
                valueSelectContainer.show();
                valueSelect.show();
                labelValue.show().text(i18next.t("choose_value"));
            }
        }


        $(document).ready(function() {
            loadAllData();
            loadDistinctValuesForProject();

            $('.value-select').not('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-project').select2({
                placeholder: i18next.t("choose_project"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%'
            });

            handleFilterTypeChange(1);
            handleFilterTypeChange(2);
            handleFilterTypeChange(3);


            $(document).on('paste', '#filter-value-2 ~ .select2 .select2-search__field', function(e) {
                e.preventDefault();
                var clipboardData = e.originalEvent.clipboardData.getData('text/plain');
                var values = clipboardData.split(/\r?\n/).reduce(function(acc, line) {
                  return acc.concat(line.split('\t'));
                }, []).filter(function(val) {
                  return val.trim() !== '';
                });
                var $select = $('#filter-value-2');
                var currentValues = $select.val() || [];
                var newValues = currentValues.concat(values);
                newValues = Array.from(new Set(newValues));
                $select.val(newValues).trigger('change');
            });

            $('#filter-project').on('change', function(){
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });

            $('#filter-column-1').on('change', function() {
                handleFilterTypeChange(1);
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });
            $('#filter-value-1, #filter-date-start-1, #filter-date-end-1').on('change', function() {
                updateCascade(2);
            });
            $('#filter-column-2').on('change', function() {
                handleFilterTypeChange(2);
                updateFilterValuesForBlock(2);
                updateCascade(3);
            });
            $('#filter-value-2, #filter-date-start-2, #filter-date-end-2').on('change', function() {
                updateCascade(3);
            });
            $('#filter-column-3').on('change', function() {
                handleFilterTypeChange(3);
                updateFilterValuesForBlock(3);
            });

            $('#apply-filters').on('click', function() {
                const col1 = $('#filter-column-1').val();
                const val1 = $('#filter-value-1').val();
                if (col1 === 'Part Number' && val1 && val1.length > 0) {
                  val1.forEach(p => saveSearchHistory(p));
                }
                applyFilters(true);
            });
            $('#clear-filters').on('click', function() {
                $('.value-select').val(null).trigger('change');
                $('#filter-value-2').val(null).trigger('change');
                $('.date-select-start').val(''); 
                $('.date-select-end').val(''); 
                handleFilterTypeChange(1);
                handleFilterTypeChange(2);
                handleFilterTypeChange(3);
                applyFilters(true);
            });
            $('#load-more').on('click', function() {
                let loadMoreFilters = { ...currentFilters, offset: currentOffset, limit: pageSize };
                delete loadMoreFilters.limit; 
                
                if (currentOffset < totalData) {
                    showSpinner();
                    $.getJSON(`/search?${$.param(loadMoreFilters)}`, function(response) {
                        currentOffset += response.data.length; 
                        updateTable(response.data, false); 
                    }).always(function() {
                        hideSpinner();
                    });
                } else {
                    alert("ƒê√£ t·∫£i h·∫øt d·ªØ li·ªáu!");
                }
            });
            $('#load-all').on('click', function() {
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                queryParams.limit = 1000000; 
                queryParams.offset = 0;
                showSpinner();
                $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                  currentOffset = response.total; 
                  updateTable(response.data, true); 
                }).always(function() {
                    hideSpinner();
                });
            });
            $('#download-excel').on('click', function() { downloadExcel(); });
            $('#export-all').on('click', function() {
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                const queryString = $.param(queryParams);
                window.location.href = `/export?${queryString}`;
            });
            $('#zoom-in').on('click', function() {
                currentZoom += 0.1;
                $('#results-table').css('zoom', currentZoom);
            });
            $('#zoom-out').on('click', function() {
                if (currentZoom > 0.5) {
                  currentZoom -= 0.1;
                  $('#results-table').css('zoom', currentZoom);
                }
            });
            try {
                if (typeof $.fn.colResizable === 'function') {
                  $('#results-table').colResizable({ liveDrag: true });
                }
            } catch(e) {
                console.log("colResizable not available:", e);
            }

            // --- C√ÅC S·ª∞ KI·ªÜN CHO POPUP ·∫¢NH (G·∫ÆN M·ªòT L·∫¶N) ---
            popupCloseButton.off('click.closepopup').on('click.closepopup', function() {
                closeImagePopup();
            });

            $(document).off('mouseup.imagePopupOutside').on('mouseup.imagePopupOutside', function(e) {
                if (imagePopup.is(':visible') && !imagePopup.is(e.target) && imagePopup.has(e.target).length === 0) {
                    closeImagePopup();
                }
            });
            
            // Re-added the click handler for zooming the image within the popup
            popupImg.off('click.zoom').on('click.zoom', function() {
                const $thisImage = $(this);
                if (imagePopup.is(':visible') && $thisImage.is(':visible')) {
                    imagePopup.toggleClass('zoomed');
                    
                    popupSpinner.show(); // Show spinner while loading new image size
                    $thisImage.hide(); // Hide current image

                    if (imagePopup.hasClass('zoomed')) {
                        // Popup is zoomed in: Load high-quality image
                        const highQualityUrl = imagePopup.data('high-quality-url');
                        if (highQualityUrl) {
                            $thisImage.attr('src', highQualityUrl);
                            $thisImage.css('cursor', 'zoom-out');
                        } else {
                            console.warn("High-quality image URL not found.");
                            popupText.text(i18next.t('no_image_found', { partNumber: imagePopup.data('current-part-number') || 'N/A', erpCode: imagePopup.data('current-erp') || 'N/A' })).show();
                            popupSpinner.hide();
                            $thisImage.show(); // Show thumbnail if high-quality is missing
                        }
                    } else {
                        // Popup is zoomed out: Load thumbnail image
                        const thumbnailUrl = imagePopup.data('thumbnail-url');
                        if (thumbnailUrl) {
                            $thisImage.attr('src', thumbnailUrl);
                            $thisImage.css('cursor', 'zoom-in');
                        } else {
                            console.warn("Thumbnail image URL not found.");
                            popupText.text(i18next.t('no_image_found', { partNumber: imagePopup.data('current-part-number') || 'N/A', erpCode: imagePopup.data('current-erp') || 'N/A' })).show();
                            popupSpinner.hide();
                            $thisImage.show(); // Show thumbnail if high-quality is missing
                        }
                    }
                }
            });

            applyFilters(true); 
        });

        function updateFilterValuesForBlock(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            if (selectedOptionDataType === 'date') {
                return;
            }
            
            if (!allData) {
                setTimeout(function(){ updateFilterValuesForBlock(blockIndex); }, 100);
                return;
            }
            let filteredData = allData.slice();

            const projectValues = $('#filter-project').val();
            if (projectValues && projectValues.length > 0) {
                filteredData = filteredData.filter(row => 
                    projectValues.some(s => row['Customer'] && row['Customer'].toString().toLowerCase().includes(s.toLowerCase()))
                );
            }

            for (let i = 1; i < blockIndex; i++) {
                const colSelectPrev = $(`#filter-column-${i}`);
                const colPrev = colSelectPrev.val();
                const prevOptionType = colSelectPrev.find('option:selected').data('type');
                
                if (prevOptionType === 'date') {
                    const dateStartPrev = $(`#filter-date-start-${i}`).val();
                    const dateEndPrev = $(`#filter-date-end-${i}`).val();
                    if (colPrev && (dateStartPrev || dateEndPrev)) {
                        filteredData = filteredData.filter(row => {
                            const itemDateStr = formatExcelDate(row[colPrev]);
                            if (!itemDateStr) return false;
                            const itemDate = new Date(itemDateStr);
                            let match = true;
                            if (dateStartPrev) {
                                match = match && itemDate >= new Date(dateStartPrev);
                            }
                            if (dateEndPrev) {
                                match = match && itemDate <= new Date(dateEndPrev);
                            }
                            return match;
                        });
                    }
                } else {
                    const valuesPrev = $('#filter-value-' + i).val();
                    if (colPrev && valuesPrev && valuesPrev.length > 0) {
                        filteredData = filteredData.filter(row =>
                            valuesPrev.some(v => row[colPrev] && row[colPrev].toString().toLowerCase().includes(v.toLowerCase()))
                        );
                    }
                }
            }
            
            let dependentColumn = $('#filter-column-' + blockIndex).val();
            let valuesInColumn = filteredData.map(function(row) {
                let cellVal = row[dependentColumn];
                if (columnSelect.find('option[value="' + dependentColumn + '"]').data('type') === 'date') {
                    cellVal = formatExcelDate(cellVal);
                }
                if (cellVal == null || cellVal.toString().trim() === "") return null;
                if (typeof cellVal === 'string') {
                    return cellVal.trim().toUpperCase();
                }
                return cellVal.toString().toUpperCase();
            }).filter(function(v) { return v !== null; });

            let distinctValues = Array.from(new Set(valuesInColumn));
            distinctValues.sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));

            const selectElem = $('#filter-value-' + blockIndex);
            const currentValue = selectElem.val();
            selectElem.empty();
            distinctValues.forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
            });
            
            if (currentValue) {
                const validCurrentValues = currentValue.filter(v => distinctValues.includes(v));
                selectElem.val(validCurrentValues);
            }
            selectElem.trigger('change.select2');
        }

        function updateCascade(startBlock) {
          for (let i = startBlock; i <= 3; i++) {
            updateFilterValuesForBlock(i);
          }
        }

        function applyFilters(reset = true) {
            if (reset) {
                currentOffset = 0;
            }
            let queryParams = { limit: pageSize, offset: currentOffset };
            const projectFilterValues = $('#filter-project').val();
            if (projectFilterValues && projectFilterValues.length > 0) {
                queryParams["Customer"] = projectFilterValues.join(',');
            }

            for (let i = 1; i <= 3; i++) {
                const colSelect = $(`#filter-column-${i}`);
                const col = colSelect.val();
                const selectedOptionDataType = colSelect.find('option:selected').data('type');
                
                if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;    
                } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                        queryParams[col] = values.join(',');
                    }
                }
            }
            
            currentFilters = {...queryParams}; 
            
            showSpinner();
            $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                totalData = response.total;
                currentOffset = reset ? response.data.length : currentOffset + response.data.length;
                updateTable(response.data, reset);
            }).always(function() {
                hideSpinner();
            });
        }

        // --- H√ÄM ƒê√ìNG V√Ä RESET POPUP (ƒê√É C√ì TRONG FILE G·ªêC, ƒê·∫¢M B·∫¢O N√ì ƒê∆Ø·ª¢C S·ª¨ D·ª§NG) ---
        function closeImagePopup() {
            imagePopup.hide().removeClass('zoomed');
            popupImg.off('load error').attr('src', '').hide().css('cursor', 'zoom-in');
            popupText.text('').hide();
            popupSpinner.hide(); // ·∫®n spinner khi ƒë√≥ng
            imagePopup.removeData('current-erp');
            imagePopup.removeData('current-part-number');
            imagePopup.removeData('thumbnail-url');
            imagePopup.removeData('high-quality-url');
        }

function updateTable(data, reset) {
    const tbody = $('#results-table tbody');
    if (reset) tbody.empty();

    data.forEach(function(row) {
        const serial = reset ? tbody.children().length + 1 : currentOffset - data.length + tbody.children().length + 1;
        const tr = $('<tr>');
        const partNumberValue = row['Part Number'] || 'N/A'; 

        tr.append(`<td class="sticky-col-1">${serial}</td>`);
        
        const partNumberCell = $(`<td>${partNumberValue}</td>`).addClass('sticky-col-2');
        partNumberCell.css('cursor', 'pointer');

        // --- S·ª¨A ƒê·ªîI S·ª∞ KI·ªÜN CLICK CHO partNumberCell ---
        partNumberCell.on('click', function(e) {
            const currentErpCode = row['ERP-CODE']?.trim().toUpperCase();
            const currentPartNumberValueFromRow = row['Part Number'] || 'N/A'; // L·∫•y tr·ª±c ti·∫øp t·ª´ row

            // 1. Copy Part Number to clipboard
            const tempInput = document.createElement('textarea');
            tempInput.value = currentPartNumberValueFromRow;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            // Provide visual feedback for copying
            const copyMessage = $('<div class="copy-feedback-message">ƒê√£ sao ch√©p: ' + currentPartNumberValueFromRow + '</div>');
            $('body').append(copyMessage);
            // Trigger reflow to ensure transition plays
            copyMessage[0].offsetHeight; 
            copyMessage.addClass('show');
            setTimeout(() => {
                copyMessage.removeClass('show');
                copyMessage.fadeOut(500, function() {
                    $(this).remove();
                });
            }, 1500); // Message disappears after 1.5 seconds

            // 2. Display Image (existing logic, ensure it's robust)
            // Reset tr·∫°ng th√°i popup
            imagePopup.removeClass('zoomed');
            popupImg.attr('src', '').hide().css('cursor', 'zoom-in');
            popupText.text('').hide();
            popupSpinner.hide(); // ƒê·∫£m b·∫£o spinner ·∫©n ban ƒë·∫ßu

            // L∆∞u th√¥ng tin c·∫ßn thi·∫øt v√†o data c·ªßa popup
            imagePopup.data('current-erp', currentErpCode);
            imagePopup.data('current-part-number', currentPartNumberValueFromRow);

            if (currentErpCode) {
                const thumbnailUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/w_250,h_250,c_limit,f_auto,q_auto:good/ERP-CODE/${currentErpCode}.jpg`;
                const highQualityUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/f_auto,q_auto:good/ERP-CODE/${currentErpCode}.jpg`;

                imagePopup.data('thumbnail-url', thumbnailUrl);
                imagePopup.data('high-quality-url', highQualityUrl);

                popupSpinner.show(); // Hi·ªÉn th·ªã spinner tr∆∞·ªõc khi t·∫£i
                popupImg.attr('src', thumbnailUrl); // B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh thumbnail

                // Re-attach load and error handlers specifically for this image load
                popupImg.off('load error').on('load', function() {
                    const expectedErp = imagePopup.data('current-erp');
                    // Only process if the loaded image matches the expected ERP code
                    if (expectedErp && $(this).attr('src') && $(this).attr('src').includes(expectedErp)) {
                        popupSpinner.hide();
                        $(this).show();
                        popupText.hide().text('');
                        // Removed the `if (imagePopup.is(':hidden'))` check here
                        imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                    }
                }).on('error', function() {
                    const expectedErp = imagePopup.data('current-erp');
                    const pn = imagePopup.data('current-part-number') || "N/A";
                    // Only process if the error is for the expected ERP code or no src was set
                    if (expectedErp && ($(this).attr('src') === '' || ($(this).attr('src') && $(this).attr('src').includes(expectedErp)))) {
                        popupSpinner.hide();
                        $(this).hide();
                        popupText.text(i18next.t('no_image_found', { partNumber: pn, erpCode: expectedErp })).show();
                        // Removed the `if (imagePopup.is(':hidden'))` check here
                        imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                    }
                });
                
                // Ensure the popup is shown when an image is expected to load
                imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();

            } else { // Kh√¥ng c√≥ ERP-CODE
                popupSpinner.hide();
                popupImg.hide();
                popupText.text(i18next.t('no_erp_code', { partNumber: currentPartNumberValueFromRow })).show();
                imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
            }
        });
        // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI S·ª∞ KI·ªÜN CLICK partNumberCell ---
        
        tr.append(partNumberCell);

        tr.append(`<td class="sticky-col-col-3">${row['REV'] || ''}</td>`);
        tr.append(`<td>${row['Approval Status'] || ''}</td>`);
        tr.append(`<td>${row['Customer'] || ''}</td>`);
        tr.append(`<td>${row['Commodity'] || ''}</td>`);
        tr.append(`<td>${row['Production Status'] || ''}</td>`);
        tr.append(`<td>${row['Part Pictures'] || ''}</td>`);
        tr.append(`<td>${row['Packaging Pictures'] || ''}</td>`);

        tr.append(`<td>${row['Critical'] || ''}</td>`);
        tr.append(`<td>${row['CE'] || ''}</td>`);
        tr.append(`<td>${row['PO Number'] || ''}</td>`);
        tr.append(`<td>${row['Description'] || ''}</td>`);
        tr.append(`<td>${row['ERP-CODE'] || ''}</td>`); 
        tr.append(`<td>${row['Note Number'] || ''}</td>`);
        tr.append(`<td>${formatExcelDate(row['PO received date'])}</td>`);
        tr.append(`<td>${formatExcelDate(row['Customer need date'])}</td>`);
        tr.append(`<td>${row['Requirements'] || ''}</td>`);
        tr.append(`<td>${row['FAIR Cover sheet'] || ''}</td>`);
        tr.append(`<td>${row['Bubble Drawings'] || ''}</td>`);
        tr.append(`<td>${row['Datasheet form'] || ''}</td>`);
        tr.append(`<td>${row['LAIR Data'] || row['LAIR data'] || ''}</td>`);
        tr.append(`<td>${row['FAIR Data'] || ''}</td>`);
        tr.append(`<td>${row['COC'] || ''}</td>`);
        tr.append(`<td>${row['BOM'] || ''}</td>`);
        tr.append(`<td>${row['Mill'] || ''}</td>`);
        tr.append(`<td>${row['Test reports / evidences'] || ''}</td>`);
        tr.append(`<td>${row['Remark 1'] || ''}</td>`);
        tr.append(`<td>${row['Remark 2'] || ''}</td>`);
        tr.append(`<td>${formatExcelDate(row['Submit date'])}</td>`);
        tr.append(`<td>${row['Reject comments'] || ''}</td>`);

        tbody.append(tr);
    });

    var totalText = i18next.t("total_rows", { count: tbody.children().length, total: totalData });
    $('#results-count').text(totalText);

    try {
        if ($.fn.colResizable) {
          $('#results-table').colResizable({ liveDrag: true, partialRefresh: true });
        }
    } catch (e) {
        console.log("colResizable not available in updateTable:", e);
    }
}


        function downloadExcel() {
            const table = document.getElementById('results-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const dateColumns = ['PO received date', 'Customer need date', 'Submit date'];

            const data = rows.map(tr => {
                const cells = Array.from(tr.querySelectorAll('td'));
                const rowObj = {};
                cells.forEach((td, index) => {
                    let val = td.textContent.trim();
                    const header = headers[index];
                    rowObj[header] = val;
                });
                return rowObj;
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, 'ketqua.xlsx');
        }

        function getColumnIndex(columnName) {
          let index = -1;
          $('#results-table th').each(function(i) {
            if ($(this).data('column') === columnName) {
              index = i;
              return false;
            }
          });
          return index;
        }
        function sortTable(column, order) {
          let rows = $('#results-table tbody tr').get();
          let colIndex = getColumnIndex(column);
          if (colIndex === -1) return;

          const isDateColumn = ['PO received date', 'Customer need date', 'Submit date'].includes(column);

          rows.sort(function(a, b) {
            let valA = $(a).children('td').eq(colIndex).text().toUpperCase();
            let valB = $(b).children('td').eq(colIndex).text().toUpperCase();

            if (isDateColumn) {
                const dateA = new Date(valA);
                const dateB = new Date(valB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return order === 'asc' ? dateA - dateB : dateB - dateA;
                }
            }
            return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });
          $.each(rows, function(index, row) {
            $('#results-table tbody').append(row);
          });

          // C·∫≠p nh·∫≠t l·∫°i c·ªôt "No" sau khi s·∫Øp x·∫øp
          $('#results-table tbody tr').each(function(index) {
            $(this).find('td:first-child').text(index + 1);
          });
        }
        $(document).on('click', '#results-table th', function () {
            const col = $(this).data('column');
            if (!col || col === "No") return; // B·ªè qua c·ªôt "No" khi s·∫Øp x·∫øp

            const currentOrder = $(this).data('order') || 'asc';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

            $('#results-table th').each(function () {
                if ($(this).data('column') !== "No") { // Ch·ªâ reset m≈©i t√™n cho c√°c c·ªôt kh√°c "No"
                    $(this).data('order', null);
                    const text = $(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim();
                    $(this).text(text);
                }
            });

            const arrow = newOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
            $(this).text($(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim() + arrow);
            $(this).data('order', newOrder);

            sortTable(col, newOrder);
        });
    </script>
    <div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999; overflow-y:auto; transition: all 0.3s ease;">
        <div style="background:#fff; padding:16px; border-radius:8px; width:95%; max-width:400px; text-align:center; margin-bottom: 10vh;">
            <h3>üì∑ Qu√©t Part Number</h3>
            <div style="position: relative; width: 100%; max-height:240px;">
                <video id="camera" playsinline autoplay style="width:100%; max-height:240px; object-fit:cover; border-radius:6px;"></video>
                <div id="ocrGuideBox" style="position: absolute; border: 2px solid red; top: 35%; left: 10%; width: 80%; height: 20%; box-sizing: border-box; pointer-events: none;"></div>
            </div>
            <div id="zoomContainer" style="display:none; margin:10px auto; text-align:center;">
              üîç Zoom:
              <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1" style="width:80%;"/>
            </div>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
                <button id="btnCapture" style="padding:10px 14px; font-size:14px; flex:1 0 40%; transition: all 0.3s ease-out;">üì∏ Ch·ª•p &amp; Qu√©t</button>
                <button id="btnApplyOcrFilter" style="padding:10px 14px; font-size:14px; flex:1 0 40%; transition: all 0.3s ease-out;">‚úÖ L·ªçc</button>
                <button id="btnCloseCamera" style="padding:10px 14px; font-size:14px; flex:1 0 40%; transition: all 0.3s ease-out;">‚ùå ƒê√≥ng</button>
            </div>
            <input id="ocrInput" type="text" placeholder="K·∫øt qu·∫£ OCR..." style="margin-top:10px; width:100%; padding:8px; font-size:14px;"/>
            <p id="ocrStatus" style="font-size:14px; margin-top:10px; margin-bottom: 20px; display: block;">ƒêang ch·ªù thao t√°c...</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnScan = document.getElementById('btnScanCamera');
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const statusP = document.getElementById('ocrStatus');
      let inputOCR = document.getElementById('ocrInput');
      const btnCapture = document.getElementById('btnCapture');
      const btnClose = document.getElementById('btnCloseCamera');
      const btnApply = document.getElementById('btnApplyOcrFilter');
      const zoomSlider = document.getElementById("zoomSlider");
      const zoomContainer = document.getElementById("zoomContainer");
      let stream, intervalId;

      function stopStream() {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          video.srcObject = null;
        }
        clearInterval(intervalId);
      }

      function cropCenterAndOCR(callback) {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const cropWidth = canvas.width * 0.8;
        const cropHeight = canvas.height * 0.2;
        const offsetX = canvas.width * 0.1;
        const offsetY = canvas.height * 0.35;
        const imageData = ctx.getImageData(offsetX, offsetY, cropWidth, cropHeight);
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = cropWidth;
        tempCanvas.height = cropHeight;
        tempCanvas.getContext("2d").putImageData(imageData, 0, 0);

        Tesseract.recognize(tempCanvas.toDataURL(), 'eng')
          .then(({ data: { text } }) => callback(text))
          .catch(() => statusP.textContent = '‚ùå L·ªói khi nh·∫≠n di·ªán.');
      }

      btnScan.addEventListener('click', async () => {
        modal.style.display = 'flex';
        statusP.textContent = 'üîÑ ƒêang kh·ªüi ƒë·ªông camera...';
        inputOCR.value = '';
        document.getElementById("ocrInput").style.display = 'block';
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
          video.play();

          const track = stream.getVideoTracks()[0];
          const capabilities = track.getCapabilities();
          if (capabilities.zoom) {
            zoomContainer.style.display = 'block';
            zoomSlider.min = capabilities.zoom.min;
            zoomSlider.max = capabilities.zoom.max;
            zoomSlider.step = capabilities.zoom.step || 0.1;
            zoomSlider.value = capabilities.zoom.min;
            zoomSlider.addEventListener("input", () => {
              track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
            });
          }
          statusP.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi camera. Nh·∫•n "Ch·ª•p & Qu√©t" ho·∫∑c gi·ªØ ch·∫ø ƒë·ªô t·ª± ƒë·ªông';
        } catch (err) {
          statusP.textContent = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera.';
        }
      });

      btnCapture.addEventListener('click', () => {
        statusP.textContent = 'üîç ƒêang qu√©t...';
        cropCenterAndOCR((text) => {
          const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
          if (lines.length === 0) return statusP.textContent = '‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d√≤ng n√†o.';

          if (lines.length === 1) {
            inputOCR.value = lines[0];
            statusP.textContent = '‚úÖ ƒê√£ nh·∫≠n 1 d√≤ng.';
          } else {
            const selectHTML = `
              <select id="ocrLineSelector" style="width:100%; padding:8px; font-size:14px; margin-top:10px;">
                ${lines.map(l => `<option>${l}</option>`).join('')}
              </select>
            `;
            inputOCR.insertAdjacentHTML('beforebegin', selectHTML);
            const selector = document.getElementById('ocrLineSelector');
            selector.addEventListener('change', () => {
              inputOCR.value = selector.value;
            });
            inputOCR.value = lines[0];
            statusP.textContent = `‚úÖ ƒê√£ nh·∫≠n ${lines.length} d√≤ng. ƒê√£ ch·ªçn d√≤ng ƒë·∫ßu ti√™n, c√≥ th·ªÉ ch·ªânh s·ª≠a.`;
          }
        });
      });

      btnApply.addEventListener('click', () => {
        const part = inputOCR.value.trim();
        if (!part) return alert('B·∫°n ch∆∞a nh·∫≠p Part Number!');
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => { 
            $('#filter-value-1').val([part]).trigger('change'); 
            if (typeof applyFilters === 'function') applyFilters(true);
            statusP.textContent = `‚úÖ ƒê√£ l·ªçc v·ªõi Part Number: ${part}`;
            saveSearchHistory(part);
            setTimeout(() => btnClose.click(), 1500);
        }, 50); 
      });

      btnClose.addEventListener('click', () => {
        modal.style.display = 'none';
        zoomContainer.style.display = 'none';
        stopStream();
        document.getElementById("ocrLineSelector")?.remove();
        inputOCR.value = '';
      });
    });
    </script>
    <script>
    window.addEventListener('resize', () => {
      const activeEl = document.activeElement;
      if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
        setTimeout(() => {
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const ocrInput = document.getElementById('ocrInput');
      if (ocrInput) {
        ocrInput.addEventListener('focus', () => {
          setTimeout(() => {
            ocrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('ocrInput');
      if (input) {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const inputs = document.querySelectorAll('.filter-bar input, .filter-bar select');
      inputs.forEach((input) => {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    });
    </script>
    <script>
    function showSpinner() {
      $('#loading-spinner').show();
    }
    function hideSpinner() {
      $('#loading-spinner').hide();
    }

    $('#quick-search').on('input', function () {
      const keyword = $(this).val().toLowerCase();
      $('#results-table tbody tr').each(function () {
        const partNumber = $(this).find('td:nth-child(2)').text().toLowerCase(); 
        $(this).toggle(partNumber.includes(keyword));
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const topContainer = document.querySelector('.top-container');
      const tableContainer = document.querySelector('.table-container');
      const quickSearch = document.getElementById('quick-search');
      const applyBtn = document.getElementById('apply-filters');
      const clearBtn = document.getElementById('clear-filters');

      let wasEditingTop = false;

      document.addEventListener('focusin', (e) => {
          if (window.innerWidth >= 768) return;
        const target = e.target;
        if (topContainer.contains(target) && ['INPUT', 'SELECT', 'TEXTAREA'].includes(target.tagName)) {
          wasEditingTop = true;
          topContainer.classList.add('full-top-container');
          topContainer.classList.remove('hide-top-container');
          tableContainer.classList.remove('show-table-only');
          quickSearch.style.display = 'none';
        } else if (target === quickSearch) {
          topContainer.classList.add('hide-top-container');
          tableContainer.classList.add('show-table-only');
        }
      });

      document.addEventListener('focusout', () => {
            if (window.innerWidth >= 768) return;
        setTimeout(() => {
          const active = document.activeElement;
          if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(active.tagName)) {
            if (wasEditingTop) {
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'none';
            } else {
              topContainer.classList.remove('full-top-container', 'hide-top-container');
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'block';
            }
          }
        }, 300);
      });

      function revealTableAndSearch() {
        wasEditingTop = false;
        topContainer.classList.remove('full-top-container', 'hide-top-container');
        quickSearch.style.display = 'block';
        tableContainer.classList.remove('show-table-only');
      }

      applyBtn?.addEventListener('click', revealTableAndSearch);
      clearBtn?.addEventListener('click', revealTableAndSearch);
    });
    </script>
    <button onclick="toggleHistoryPopup()" style="position: fixed; bottom: 20px; left: 20px; background: #00cc99; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 20px; cursor: pointer; z-index: 9999; transition: all 0.3s ease-out;" title="L·ªãch s·ª≠ t√¨m ki·∫øm">üïò</button>
    <div id="floating-history-popup" style="display: none; position: fixed; bottom: 80px; left: 20px; background: rgba(30,30,30,0.95); color: white; padding: 16px; border-radius: 12px; width: 300px; max-height: 360px; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 9999;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0;">üìú L·ªãch s·ª≠ t√¨m ki·∫øm</h4>
            <button onclick="toggleHistoryPopup()" style="background: transparent; color: white; border: none; font-size: 20px; cursor: pointer; transition: all 0.3s ease-out;">√ó</button>
        </div>
        <ul id="searchHistory" style="list-style: none; padding-left: 0; margin: 12px 0;"></ul>
        <button onclick="clearSearchHistory()" style="margin-top: 8px; background:#cc4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width:100%; transition: all 0.3s ease-out;">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
    </div>

    <a href="/voice_search" style="position: fixed; bottom: 20px; right: 20px; background: #0066ff; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; text-decoration: none; z-index: 9999; transition: all 0.3s ease-out;" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
      üé§
    </a>

    <script>
      function saveSearchHistory(partNumber) {
        if (!partNumber) return;
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const now = new Date().toLocaleString("vi-VN");
        const existingIndex = history.findIndex(item => item.partNumber === partNumber);
        if (existingIndex > -1) {
            history.splice(existingIndex, 1);
        }
        history.unshift({ partNumber, time: now });
        if (history.length > 30) history.pop();
        localStorage.setItem("partSearchHistory", JSON.stringify(history));
        renderSearchHistory();
      }

      function renderSearchHistory() {
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const list = document.getElementById("searchHistory");
        if (!list) return;
        list.innerHTML = "";
        history.forEach(item => {
          const li = document.createElement("li");
          li.style.marginBottom = "6px";
          li.innerHTML = `<button onclick="quickSearchFromHistory('${item.partNumber.replace(/'/g, "\\'")}'); navigator.clipboard.writeText('${item.partNumber.replace(/'/g, "\\'")}')" title="Click ƒë·ªÉ tra c·ª©u v√† sao ch√©p" style="background:#444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width: calc(100% - 70px); text-align:left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.3s ease-out;">${item.partNumber}</button> <small style="color:#ccc; font-size: 10px;">(${item.time.split(',')[0]})</small>`;
          list.appendChild(li);
        });
      }

      function quickSearchFromHistory(partNumber) {
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => {
            $('#filter-value-1').val([partNumber]).trigger('change');
            applyFilters(true);
            toggleHistoryPopup(); 
        }, 50);
      }

      function clearSearchHistory() {
        localStorage.removeItem("partSearchHistory");
        renderSearchHistory();
      }
      
      function toggleHistoryPopup() {
          const popup = document.getElementById("floating-history-popup");
          if (popup) {
            const isOpen = popup.style.display === "block";
            popup.style.display = isOpen ? "none" : "block";
            if (!isOpen) {
              renderSearchHistory();
            }
          }
      }
      window.addEventListener("DOMContentLoaded", renderSearchHistory);
    </script>
</body>
</html>
