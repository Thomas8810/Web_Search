<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
    <style>
        body {
            font-family: sans-serif;
            background: #1e1e2f;
            color: white;
            margin: 0;
            padding: 1rem;
            text-align: center;
        }
        .mode-select {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .mode-select button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }
        .mode-active {
            background: #00cc99;
            color: white;
        }
        .mode-inactive {
            background: #444;
            color: #ccc;
        }
        #recordBtn {
            margin-top: 1rem;
            font-size: 1.2rem;
            padding: 1rem 2rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, ch·ªâ hi·ªán khi ch·ªçn mode gi·ªçng n√≥i */
        }
        .table-scroll {
            overflow-x: auto;
            margin-top: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.9rem;
        }
        thead th {
            position: sticky;
            top: 0;
            background: #333;
            color: #fff;
            z-index: 3;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
            white-space: nowrap;
        }
        tr.active-row {
            background-color: #2a2a4d;
        }

        @media (min-width: 600px) {
            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                min-width: 80px;
                background: #1e1e2f;
                z-index: 4;
            }
            th:nth-child(2), td:nth-child(2) {
                position: sticky;
                left: 80px;
                min-width: 180px;
                background: #1e1e2f;
                z-index: 4;
            }
            th:nth-child(3), td:nth-child(3) {
                position: sticky;
                left: 260px;
                min-width: 100px;
                background: #1e1e2f;
                z-index: 4;
            }
        }

        #backHome {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            text-decoration: none;
            border: 1px solid #ccc;
        }
            
        #statusListening {
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ffcc;
            animation: pulse 1s infinite;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, ch·ªâ hi·ªán khi c√≥ tr·∫°ng th√°i */
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>

    <div class="mode-select">
        <button id="modeText" class="mode-active">‚å®Ô∏è Nh·∫≠p tay</button>
        <button id="modeVoice" class="mode-inactive">üéôÔ∏è Gi·ªçng n√≥i</button>
    </div>

    <div class="search-text-area" style="margin: 1rem 0; display: block;">
        <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a Part Number..." style="padding: 0.5rem; width: 60%; font-size: 1rem; border-radius: 6px; border: none;"/>
        <button id="searchBtn" style="padding: 0.5rem 1rem; margin-left: 0.5rem; border-radius: 6px; background: #007bff; color: white; border: none;">üîç T√¨m</button>
    </div>

    <div class="mode-select">
        <button id="modeImage" class="mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
        <button id="modeStatus" class="mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
    </div>

    <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
    <div id="statusListening" style="margin-top:1rem;"></div>
    <div id="result" style="margin-top:1rem;"></div>
    <div class="table-scroll" id="relatedResults"></div>

    <a href="/home" id="backHome">‚Üê Trang ch·ªß</a>

    <hr style="margin-top:2rem; border:none; border-top:1px solid #666;">
    <h3>üìú L·ªãch s·ª≠ t√¨m ki·∫øm g·∫ßn ƒë√¢y</h3>
    <ul id="historyList" style="list-style:none; padding:0; text-align:left;"></ul>
    <button onclick="clearHistory()" style="margin-top:0.5rem; background:#cc4444; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">
        üóëÔ∏è X√≥a l·ªãch s·ª≠
    </button>

    <script>
        // --- Bi·∫øn v√† tham chi·∫øu DOM ---
        let analysisMode = 'image'; // 'image' ho·∫∑c 'status'
        let inputMode = 'text'; // 'text' ho·∫∑c 'voice'

        const btnImage = document.getElementById('modeImage');
        const btnStatus = document.getElementById('modeStatus');
        const btnText = document.getElementById('modeText');
        const btnVoice = document.getElementById('modeVoice');
        const recordBtn = document.getElementById("recordBtn");
        const searchInput = document.getElementById("searchInput");
        const searchBtn = document.getElementById("searchBtn");
        const searchTextArea = document.querySelector(".search-text-area");
        const resultDiv = document.getElementById("result");
        const statusDiv = document.getElementById("statusListening");
        const relatedResultsDiv = document.getElementById("relatedResults");
        const historyList = document.getElementById("historyList");

        let recognition = null; // Kh·ªüi t·∫°o null, s·∫Ω g√°n khi startRecognition
        let isListening = false;
        let finalTranscriptReceived = false; // Bi·∫øn c·ªù ƒë·ªÉ ki·ªÉm so√°t onend

        // --- H√†m ti·ªán √≠ch ---
        function updateModeButtons() {
            // C·∫≠p nh·∫≠t n√∫t inputMode
            if (inputMode === 'text') {
                btnText.classList.add('mode-active');
                btnText.classList.remove('mode-inactive');
                btnVoice.classList.remove('mode-active');
                btnVoice.classList.add('mode-inactive');
                searchTextArea.style.display = 'block';
                recordBtn.style.display = 'none';
                statusDiv.style.display = 'none'; // ·∫®n tr·∫°ng th√°i khi ·ªü ch·∫ø ƒë·ªô nh·∫≠p tay
                stopRecognition(); // D·ª´ng ghi √¢m n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô gi·ªçng n√≥i
            } else { // voice mode
                btnVoice.classList.add('mode-active');
                btnVoice.classList.remove('mode-inactive');
                btnText.classList.remove('mode-active');
                btnText.classList.add('mode-inactive');
                searchTextArea.style.display = 'none';
                recordBtn.style.display = 'inline-block';
                // statusDiv s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã khi startRecognition
            }

            // C·∫≠p nh·∫≠t n√∫t analysisMode
            if (analysisMode === 'image') {
                btnImage.classList.add('mode-active');
                btnImage.classList.remove('mode-inactive');
                btnStatus.classList.remove('mode-active');
                btnStatus.classList.add('mode-inactive');
            } else { // status mode
                btnStatus.classList.add('mode-active');
                btnStatus.classList.remove('mode-inactive');
                btnImage.classList.remove('mode-active');
                btnImage.classList.add('mode-inactive');
            }
        }

        async function fetchData() {
            try {
                const res = await fetch("/api/data");
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                console.error("Error fetching data:", error);
                statusDiv.style.display = 'block'; // Hi·ªÉn th·ªã tr·∫°ng th√°i l·ªói
                statusDiv.innerText = "‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.";
                return []; // Tr·∫£ v·ªÅ m·∫£ng r·ªóng ƒë·ªÉ tr√°nh l·ªói khi filter
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "vi-VN";
                speechSynthesis.speak(utterance);
            } else {
                console.warn("Speech Synthesis API kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát n√†y.");
            }
        }

        function analyzePart(part) {
            const status = part["Approval Status"]?.toUpperCase() || "";
            const partPic = part["Part Pictures"]?.toUpperCase() || "";
            const packPic = part["Packaging Pictures"]?.toUpperCase() || "";

            if (analysisMode === 'image') {
                if (["REJECTED", "EXPIRED"].includes(status)) return "Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.";
                if (["APPROVED", "CLOSED", "SUBMITTED"].includes(status)) return "Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
                if (status === "ON GOING") {
                    if (partPic !== "OK" && packPic !== "OK") return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m v√† ·∫£nh ƒë√≥ng g√≥i.";
                    if (partPic !== "OK") return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.";
                    if (packPic !== "OK") return "C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.";
                    if (partPic === "OK" && packPic === "OK") return "Kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
                }
            } else { // status mode
                const map = {
                    "APPROVED": "ƒê√£ ph√™ duy·ªát",
                    "CLOSED": "ƒê√£ ƒë√≥ng",
                    "EXPIRED": "H·∫øt h·∫°n",
                    "ON GOING": "ƒêang th·ª±c hi·ªán",
                    "REJECTED": "B·ªã t·ª´ ch·ªëi",
                    "SUBMITTED": "ƒê√£ g·ª≠i"
                };
                return map[status] || `Tr·∫°ng th√°i: ${status}`;
            }
            return "Kh√¥ng r√µ tr·∫°ng th√°i.";
        }

        function makeTableSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const headers = table.querySelectorAll('th');
            headers.forEach((th, colIndex) => {
                th.style.cursor = 'pointer';
                const oldArrow = th.querySelector('span');
                if (oldArrow) oldArrow.remove();

                const arrow = document.createElement('span');
                arrow.style.marginLeft = '6px';
                arrow.style.fontSize = '0.8rem';
                th.appendChild(arrow);

                th.addEventListener('click', () => {
                    const rows = Array.from(table.querySelectorAll('tbody > tr'));
                    const isAsc = th.dataset.order !== 'asc';
                    rows.sort((a, b) => {
                        const aText = a.children[colIndex].textContent.trim();
                        const bText = b.children[colIndex].textContent.trim();
                        return isAsc ? aText.localeCompare(bText, 'vi', { numeric: true }) : bText.localeCompare(aText, 'vi', { numeric: true });
                    });
                    rows.forEach(row => table.querySelector('tbody').appendChild(row));

                    headers.forEach(h => {
                        h.dataset.order = '';
                        h.querySelector('span').textContent = '';
                    });

                    th.dataset.order = isAsc ? 'asc' : 'desc';
                    arrow.textContent = isAsc ? '‚ñ≤' : '‚ñº';
                });
            });
        }

        function showImageInCell(erpCode, cellElement) {
            cellElement.innerHTML = ''; 

            if (!erpCode) {
                cellElement.innerHTML = '<div style="padding:4px;font-style:italic;color:gray">No photo</div>';
                return;
            }

            const img = document.createElement('img');
            img.className = 'table-thumbnail-image'; 
            img.src = `https://res.cloudinary.com/dyjcw9mlz/image/upload/w_80,h_60,c_fit/ERP-CODE/${erpCode}.jpg`;
            img.alt = `·∫¢nh Part ${erpCode}`;
            img.style.maxWidth = '80px';
            img.style.maxHeight = '60px';
            img.style.border = '1px solid gray';
            img.style.cursor = 'pointer'; 

            img.onerror = function() {
                cellElement.innerHTML = '<div style="padding:4px;font-style:italic;color:gray">No photo</div>';
            };
            cellElement.appendChild(img);
        }

        async function processTranscript(transcript, fromHistory = false) {
            const cleaned = transcript.replace(/\s+/g, '').toUpperCase();
            if (!fromHistory) saveToHistory(cleaned);
            
            resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${transcript}</b><br>‚Üí Chu·∫©n h√≥a: <b>${cleaned}</b>`;
            statusDiv.style.display = 'block';
            statusDiv.innerText = "‚è≥ ƒêang t√¨m ki·∫øm...";
            relatedResultsDiv.innerHTML = ""; 

            const data = await fetchData();
            if (data.length === 0) {
                statusDiv.innerText = "‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ tra c·ª©u.";
                speak("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ tra c·ª©u.");
                return;
            }

            const results = data.filter(row => typeof row["Part Number"] === "string" && row["Part Number"].toUpperCase().includes(cleaned));

            if (results.length === 0) {
                statusDiv.innerText = "";
                speak("Kh√¥ng t√¨m th·∫•y Part Number.");
                resultDiv.innerHTML += `<br>‚ùå Kh√¥ng t√¨m th·∫•y Part Number.`;
            } else {
                statusDiv.innerText = ""; 
                const msg = analyzePart(results[0]); 

                if (results.length === 1) {
                    resultDiv.innerHTML += `<br/>‚úÖ ${msg}`;
                    speak(msg);
                } else {
                    speak(`T√¨m th·∫•y ${results.length} k·∫øt qu·∫£ g·∫ßn gi·ªëng.`);
                    resultDiv.innerHTML += `<br/>‚úÖ T√¨m th·∫•y ${results.length} k·∫øt qu·∫£ g·∫ßn gi·ªëng. (Hi·ªÉn th·ªã 10 k·∫øt qu·∫£ ƒë·∫ßu ti√™n)`;
                }
                
                let html = `<table id='resultsTable'><thead><tr>
                    <th>No.</th><th>Part Number</th><th>REV</th><th>Approval Status</th><th>Customer</th>
                    <th>Commodity</th><th>Part Pictures</th><th>Packaging Pictures</th><th>Critical</th>
                    <th>CE</th><th>·∫¢nh</th></tr></thead><tbody>`;

                results.slice(0, 10).forEach((item, index) => {
                    html += `<tr onclick="speak('${analyzePart(item).replace(/'/g, "\\'")}')">
                        <td>${index + 1}</td>
                        <td>${item["Part Number"] || ""}</td>
                        <td>${item["REV"] || ""}</td>
                        <td>${item["Approval Status"] || ""}</td>
                        <td>${item["Customer"] || ""}</td>
                        <td>${item["Commodity"] || ""}</td>
                        <td>${item["Part Pictures"] || ""}</td>
                        <td>${item["Packaging Pictures"] || ""}</td>
                        <td>${item["Critical"] || ""}</td>
                        <td>${item["CE"] || ""}</td>
                        <td id="imageCell-${item["Part Number"].replace(/\s+/g, '-')}-${index}"></td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                relatedResultsDiv.innerHTML = html;
                makeTableSortable('resultsTable');

                results.slice(0, 10).forEach((item, index) => {
                    const erpCode = item["ERP-CODE"]?.toUpperCase() || "";
                    // S·ª≠ d·ª•ng ID chu·∫©n h√≥a ƒë·ªÉ tr√°nh l·ªói n·∫øu Part Number c√≥ kho·∫£ng tr·∫Øng ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát
                    const imageCell = document.getElementById(`imageCell-${item["Part Number"].replace(/\s+/g, '-')}-${index}`);
                    if (imageCell) {
                        showImageInCell(erpCode, imageCell);
                    }
                });
            }
        }

        // --- Qu·∫£n l√Ω l·ªãch s·ª≠ t√¨m ki·∫øm ---
        function saveToHistory(partNumber) {
            const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
            const now = new Date().toLocaleString("vi-VN");
            if (history.length > 0 && history[0].partNumber === partNumber) {
                return;
            }
            history.unshift({ partNumber, time: now });
            if (history.length > 20) history.pop();
            localStorage.setItem("searchHistory", JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
            historyList.innerHTML = "";
            history.forEach(item => {
                const li = document.createElement("li");
                li.style.marginBottom = "6px";
                li.innerHTML = `
                <button onclick="processTranscript('${item.partNumber.replace(/'/g, "\\'")}', true); navigator.clipboard.writeText('${item.partNumber.replace(/'/g, "\\'")}')" 
                    title="Click ƒë·ªÉ tra c·ª©u v√† sao ch√©p" 
                    style="background:#444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">
                    ${item.partNumber}</button> <small style="color:#ccc">(${item.time})</small>`;
                historyList.appendChild(li);
            });
        }

        function clearHistory() {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?")) {
                localStorage.removeItem("searchHistory");
                renderHistory();
            }
        }

        // --- X·ª≠ l√Ω s·ª± ki·ªán nh·∫≠n di·ªán gi·ªçng n√≥i ---
        function startRecognition() {
            if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
                statusDiv.style.display = 'block';
                statusDiv.innerText = "‚ùå Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i. Vui l√≤ng s·ª≠ d·ª•ng Google Chrome ho·∫∑c tr√¨nh duy·ªát kh√°c c√≥ h·ªó tr·ª£.";
                speak("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i.");
                recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
                return;
            }

            if (recognition) {
                recognition.stop(); // ƒê·∫£m b·∫£o d·ª´ng phi√™n tr∆∞·ªõc n·∫øu c√≥
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = "vi-VN";
            recognition.interimResults = true;
            finalTranscriptReceived = false; // Reset c·ªù

            recognition.onstart = () => {
                isListening = true;
                recordBtn.innerText = "üõë Nh·∫•n ƒë·ªÉ d·ª´ng";
                statusDiv.style.display = 'block';
                statusDiv.innerText = "üéß ƒêang nghe...";
                resultDiv.innerHTML = "";
                relatedResultsDiv.innerHTML = "";
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        finalTranscriptReceived = true; // ƒê·∫∑t c·ªù khi c√≥ k·∫øt qu·∫£ cu·ªëi c√πng
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${finalTranscript || interimTranscript}</b>`;
                if (finalTranscript) {
                    processTranscript(finalTranscript); // X·ª≠ l√Ω ngay khi c√≥ final transcript
                }
            };

            recognition.onerror = (e) => {
                statusDiv.style.display = 'block';
                statusDiv.innerText = `‚ùå L·ªói: ${e.error}. Vui l√≤ng th·ª≠ l·∫°i.`;
                speak("ƒê√£ x·∫£y ra l·ªói nh·∫≠n di·ªán gi·ªçng n√≥i.");
                recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
                isListening = false;
            };

            recognition.onend = () => {
                isListening = false;
                recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
                if (!finalTranscriptReceived) {
                    // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£ cu·ªëi c√πng ƒë∆∞·ª£c nh·∫≠n (v√≠ d·ª•: ng∆∞·ªùi d√πng kh√¥ng n√≥i g√¨)
                    statusDiv.style.display = 'block';
                    statusDiv.innerText = "Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                    resultDiv.innerHTML = ""; // X√≥a n·ªôi dung "B·∫°n n√≥i: "
                } else {
                    // N·∫øu ƒë√£ c√≥ k·∫øt qu·∫£ cu·ªëi c√πng, tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi processTranscript
                    // Ho·∫∑c b·∫°n c√≥ th·ªÉ x√≥a tr·∫°ng th√°i nghe n·∫øu processTranscript ƒë√£ xong
                    if (statusDiv.innerText.includes("ƒêang nghe...")) { // Ch·ªâ x√≥a n·∫øu kh√¥ng c√≥ l·ªói ho·∫∑c k·∫øt qu·∫£ t·ª´ processTranscript
                       statusDiv.innerText = "";
                       statusDiv.style.display = 'none';
                    }
                }
            };

            recognition.start();
        }

        function stopRecognition() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                // statusDiv s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong onend
            }
        }

        // --- X·ª≠ l√Ω s·ª± ki·ªán click DOM ---
        recordBtn.onclick = () => {
            if (!isListening) {
                startRecognition();
            } else {
                stopRecognition();
            }
        };

        searchBtn.onclick = () => {
            const val = searchInput.value;
            if (val.trim() !== '') {
                processTranscript(val, false);
            } else {
                resultDiv.innerHTML = "Vui l√≤ng nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm.";
                relatedResultsDiv.innerHTML = "";
                statusDiv.style.display = 'none'; // ·∫®n tr·∫°ng th√°i khi kh√¥ng t√¨m ki·∫øm
            }
        };

        btnImage.onclick = () => {
            analysisMode = 'image';
            updateModeButtons();
        };

        btnStatus.onclick = () => {
            analysisMode = 'status';
            updateModeButtons();
        };

        btnText.onclick = () => {
            inputMode = 'text';
            updateModeButtons();
        };

        btnVoice.onclick = () => {
            inputMode = 'voice';
            updateModeButtons();
        };

        // Highlight h√†ng khi click v√†o
        document.addEventListener('click', function(e) {
            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(r => r.classList.remove('active-row'));
            const targetRow = e.target.closest('tr');
            if (targetRow && targetRow.parentNode.tagName === 'TBODY') {
                targetRow.classList.add('active-row');
            }
        });

        // --- Kh·ªüi t·∫°o khi t·∫£i trang ---
        window.onload = () => {
            updateModeButtons(); // Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa c√°c n√∫t v√† hi·ªÉn th·ªã/·∫©n input/recordBtn
            renderHistory(); // T·∫£i l·ªãch s·ª≠ t√¨m ki·∫øm
        };
    </script>
</body>
</html>
