<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
    <style>
        body {
            font-family: sans-serif;
            background: #1e1e2f;
            color: white;
            margin: 0;
            padding: 1rem;
            text-align: center;
        }
        .mode-select {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .mode-select button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }
        .mode-active {
            background: #00cc99;
            color: white;
        }
        .mode-inactive {
            background: #444;
            color: #ccc;
        }
        #recordBtn {
            margin-top: 1rem;
            font-size: 1.2rem;
            padding: 1rem 2rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, ch·ªâ hi·ªán khi ch·ªçn mode gi·ªçng n√≥i */
        }
        .table-scroll {
            overflow-x: auto;
            margin-top: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.9rem;
        }
        thead th {
            position: sticky;
            top: 0;
            background: #333;
            color: #fff;
            z-index: 3;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
            white-space: nowrap;
            text-align: center; /* CƒÉn gi·ªØa n·ªôi dung √¥ */
            vertical-align: middle; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
        }
        /* *** Th√™m cursor pointer cho h√†ng *** */
        tbody tr {
            cursor: pointer;
        }
        tbody tr:hover {
            background-color: #252540;
        }
        tr.active-row {
            background-color: #2a2a4d;
            font-weight: bold;
        }

        @media (min-width: 600px) {
            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                min-width: 80px;
                background: #1e1e2f;
                z-index: 4;
            }
            th:nth-child(2), td:nth-child(2) {
                position: sticky;
                left: 80px;
                min-width: 180px;
                background: #1e1e2f;
                z-index: 4;
            }
            th:nth-child(3), td:nth-child(3) {
                position: sticky;
                left: 260px;
                min-width: 100px;
                background: #1e1e2f;
                z-index: 4;
            }
             /* ƒê·∫£m b·∫£o n·ªÅn cho h√†ng ƒë∆∞·ª£c ch·ªçn kh√¥ng b·ªã ƒë√® */
            tr.active-row td:first-child,
            tr.active-row td:nth-child(2),
            tr.active-row td:nth-child(3) {
                background: #2a2a4d;
            }
        }

        #backHome {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            text-decoration: none;
            border: 1px solid #ccc;
        }
            
        #statusListening {
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ffcc;
            animation: pulse 1s infinite;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n, ch·ªâ hi·ªán khi c√≥ tr·∫°ng th√°i */
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Styles cho Modal ph√≥ng to ·∫£nh */
        .image-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            border: 2px solid white;
        }

        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* Style cho ·∫£nh thumbnail trong b·∫£ng */
        .thumbnail-image {
            width: 80px; /* K√≠ch th∆∞·ªõc thumbnail */
            height: 60px;
            cursor: pointer; /* Bi·ªÉu t∆∞·ª£ng con tr·ªè */
            object-fit: cover; /* Hi·ªÉn th·ªã ·∫£nh v·ª´a v·∫∑n */
            border: 1px solid #555;
            border-radius: 4px;
            transition: transform 0.2s ease; /* Hi·ªáu ·ª©ng khi hover */
        }
        .thumbnail-image:hover {
           transform: scale(1.1); /* Ph√≥ng to nh·∫π khi hover */
        }

        .no-photo-text {
            color: gray;
            font-style: italic;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>

    <div class="mode-select">
        <button id="modeText" class="mode-active">‚å®Ô∏è Nh·∫≠p tay</button>
        <button id="modeVoice" class="mode-inactive">üéôÔ∏è Gi·ªçng n√≥i</button>
    </div>

    <div class="search-text-area" style="margin: 1rem 0; display: block;">
        <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a Part Number..." style="padding: 0.5rem; width: 60%; font-size: 1rem; border-radius: 6px; border: none;"/>
        <button id="searchBtn" style="padding: 0.5rem 1rem; margin-left: 0.5rem; border-radius: 6px; background: #007bff; color: white; border: none;">üîç T√¨m</button>
    </div>

    <div class="mode-select">
        <button id="modeImage" class="mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
        <button id="modeStatus" class="mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
    </div>

    <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
    <div id="statusListening" style="margin-top:1rem;"></div>
    <div id="result" style="margin-top:1rem;"></div>
    <div class="table-scroll" id="relatedResults"></div>

    <a href="/home" id="backHome">‚Üê Trang ch·ªß</a>

    <hr style="margin-top:2rem; border:none; border-top:1px solid #666;">
    <h3>üìú L·ªãch s·ª≠ t√¨m ki·∫øm g·∫ßn ƒë√¢y</h3>
    <ul id="historyList" style="list-style:none; padding:0; text-align:left;"></ul>
    <button onclick="clearHistory()" style="margin-top:0.5rem; background:#cc4444; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">
        üóëÔ∏è X√≥a l·ªãch s·ª≠
    </button>

    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="img01">
    </div>

    <script>
        // --- Bi·∫øn v√† tham chi·∫øu DOM ---
        let analysisMode = 'image'; // 'image' ho·∫∑c 'status'
        let inputMode = 'text'; // 'text' ho·∫∑c 'voice'

        const btnImage = document.getElementById('modeImage');
        const btnStatus = document.getElementById('modeStatus');
        const btnText = document.getElementById('modeText');
        const btnVoice = document.getElementById('modeVoice');
        const recordBtn = document.getElementById("recordBtn");
        const searchInput = document.getElementById("searchInput");
        const searchBtn = document.getElementById("searchBtn");
        const searchTextArea = document.querySelector(".search-text-area");
        const resultDiv = document.getElementById("result");
        const statusDiv = document.getElementById("statusListening");
        const relatedResultsDiv = document.getElementById("relatedResults");
        const historyList = document.getElementById("historyList");

        // Modal elements
        const imageModal = document.getElementById("imageModal");
        const modalImg = document.getElementById("img01");
        const modalCloseBtn = document.getElementsByClassName("image-modal-close")[0];

        let recognition = null; 
        let isListening = false;
        let finalTranscriptReceived = false; 

        // --- H√†m ti·ªán √≠ch ---
        function updateModeButtons() {
            if (inputMode === 'text') {
                btnText.classList.add('mode-active');
                btnText.classList.remove('mode-inactive');
                btnVoice.classList.remove('mode-active');
                btnVoice.classList.add('mode-inactive');
                searchTextArea.style.display = 'block';
                recordBtn.style.display = 'none';
                statusDiv.style.display = 'none'; 
                stopRecognition(); 
            } else { 
                btnVoice.classList.add('mode-active');
                btnVoice.classList.remove('mode-inactive');
                btnText.classList.remove('mode-active');
                btnText.classList.add('mode-inactive');
                searchTextArea.style.display = 'none';
                recordBtn.style.display = 'inline-block';
            }

            if (analysisMode === 'image') {
                btnImage.classList.add('mode-active');
                btnImage.classList.remove('mode-inactive');
                btnStatus.classList.remove('mode-active');
                btnStatus.classList.add('mode-inactive');
            } else { 
                btnStatus.classList.add('mode-active');
                btnStatus.classList.remove('mode-inactive');
                btnImage.classList.remove('mode-active');
                btnImage.classList.add('mode-inactive');
            }
        }

        async function fetchData() {
            try {
                const res = await fetch("/api/data");
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                console.error("Error fetching data:", error);
                statusDiv.style.display = 'block'; 
                statusDiv.innerText = "‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.";
                return []; 
            }
        }

        function speak(text) {
             // D·ª´ng vi·ªác ƒë·ªçc tr∆∞·ªõc ƒë√≥ (n·∫øu c√≥) ƒë·ªÉ tr√°nh ƒë·ªçc ch·ªìng ch√©o
            if ('speechSynthesis' in window && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = "vi-VN";
                // Th√™m m·ªôt ch√∫t delay ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác cancel ƒë√£ ho√†n t·∫•t (n·∫øu c·∫ßn)
                setTimeout(() => speechSynthesis.speak(utterance), 50);
            } else {
                console.warn("Speech Synthesis API kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n tr√¨nh duy·ªát n√†y.");
            }
        }

        function analyzePart(part) {
            // ƒê·∫£m b·∫£o part l√† object v√† c√≥ c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt
            if (!part) return "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.";

            const status = part["Approval Status"]?.toUpperCase() || "";
            const partPic = part["Part Pictures"]?.toUpperCase() || "";
            const packPic = part["Packaging Pictures"]?.toUpperCase() || "";

            if (analysisMode === 'image') {
                if (["REJECTED", "EXPIRED"].includes(status)) return "Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.";
                if (["APPROVED", "CLOSED", "SUBMITTED"].includes(status)) return "Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
                if (status === "ON GOING") {
                    if (partPic !== "OK" && packPic !== "OK") return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m v√† ·∫£nh ƒë√≥ng g√≥i.";
                    if (partPic !== "OK") return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.";
                    if (packPic !== "OK") return "C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.";
                    if (partPic === "OK" && packPic === "OK") return "Kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
                }
            } else { 
                const map = {
                    "APPROVED": "ƒê√£ ph√™ duy·ªát",
                    "CLOSED": "ƒê√£ ƒë√≥ng",
                    "EXPIRED": "H·∫øt h·∫°n",
                    "ON GOING": "ƒêang th·ª±c hi·ªán",
                    "REJECTED": "B·ªã t·ª´ ch·ªëi",
                    "SUBMITTED": "ƒê√£ g·ª≠i"
                };
                return map[status] || `Tr·∫°ng th√°i: ${status || 'Kh√¥ng r√µ'}`;
            }
            return `Tr·∫°ng th√°i: ${status || 'Kh√¥ng r√µ'}`; // Tr·∫£ v·ªÅ m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng kh·ªõp
        }

        function makeTableSortable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const headers = table.querySelectorAll('th');
            headers.forEach((th, colIndex) => {
                th.style.cursor = 'pointer';
                const oldArrow = th.querySelector('span');
                if (oldArrow) oldArrow.remove();

                const arrow = document.createElement('span');
                arrow.style.marginLeft = '6px';
                arrow.style.fontSize = '0.8rem';
                th.appendChild(arrow);

                th.addEventListener('click', () => {
                    const rows = Array.from(table.querySelectorAll('tbody > tr'));
                    const isAsc = th.dataset.order !== 'asc'; 
                    rows.sort((a, b) => {
                        const aText = a.children[colIndex].textContent.trim();
                        const bText = b.children[colIndex].textContent.trim();
                        return isAsc ? aText.localeCompare(bText, 'vi', { numeric: true }) : bText.localeCompare(aText, 'vi', { numeric: true });
                    });
                    rows.forEach(row => table.querySelector('tbody').appendChild(row));

                    headers.forEach(h => {
                        h.dataset.order = '';
                        h.querySelector('span').textContent = '';
                    });

                    th.dataset.order = isAsc ? 'asc' : 'desc';
                    arrow.textContent = isAsc ? '‚ñ≤' : '‚ñº';
                });
            });
        }

        function showFullImage(erpCode) {
            modalImg.src = `https://res.cloudinary.com/dyjcw9mlz/image/upload/ERP-CODE/${erpCode}.jpg`;
            imageModal.style.display = "flex"; 
            modalImg.onerror = function() {
                modalImg.src = ''; 
                modalImg.alt = "Kh√¥ng t√¨m th·∫•y ·∫£nh";
                alert("Kh√¥ng t√¨m th·∫•y ·∫£nh cho Part Number n√†y.");
                imageModal.style.display = "none";
            };
        }

        function renderImageCell(erpCode, cellElement) {
            cellElement.innerHTML = ''; 

            if (!erpCode) {
                cellElement.innerHTML = '<div class="no-photo-text">No photo</div>';
                return;
            }
            
            const thumbnailImg = document.createElement('img');
            thumbnailImg.src = `https://res.cloudinary.com/dyjcw9mlz/image/upload/w_80,h_60,c_fill/ERP-CODE/${erpCode}.jpg`; 
            thumbnailImg.alt = 'Thumbnail';
            thumbnailImg.className = 'thumbnail-image';

            thumbnailImg.onclick = (e) => {
                e.stopPropagation(); 
                showFullImage(erpCode);
            };

            thumbnailImg.onerror = function() {
                cellElement.innerHTML = '<div class="no-photo-text">No photo</div>';
            };

            cellElement.appendChild(thumbnailImg); 
        }

        async function processTranscript(transcript, fromHistory = false) {
            const cleaned = transcript.replace(/\s+/g, '').toUpperCase();
            if (!fromHistory) saveToHistory(cleaned);
            
            resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${transcript}</b><br>‚Üí Chu·∫©n h√≥a: <b>${cleaned}</b>`;
            statusDiv.style.display = 'block';
            statusDiv.innerText = "‚è≥ ƒêang t√¨m ki·∫øm...";
            relatedResultsDiv.innerHTML = ""; 

            const data = await fetchData();
            if (data.length === 0) {
                statusDiv.innerText = "‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ tra c·ª©u.";
                speak("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ tra c·ª©u.");
                return;
            }

            const results = data.filter(row => typeof row["Part Number"] === "string" && row["Part Number"].toUpperCase().includes(cleaned));

            if (results.length === 0) {
                statusDiv.innerText = "";
                speak("Kh√¥ng t√¨m th·∫•y Part Number.");
                resultDiv.innerHTML += `<br>‚ùå Kh√¥ng t√¨m th·∫•y Part Number.`;
            } else {
                statusDiv.innerText = ""; 
                const msg = analyzePart(results[0]); 

                if (results.length === 1) {
                    resultDiv.innerHTML += `<br/>‚úÖ ${msg}`;
                    speak(msg);
                } else {
                    speak(`T√¨m th·∫•y ${results.length} k·∫øt qu·∫£ g·∫ßn gi·ªëng.`);
                    resultDiv.innerHTML += `<br/>‚úÖ T√¨m th·∫•y ${results.length} k·∫øt qu·∫£ g·∫ßn gi·ªëng. (Hi·ªÉn th·ªã 10 k·∫øt qu·∫£ ƒë·∫ßu ti√™n)`;
                }
                
                let html = `<table id='resultsTable'><thead><tr>
                    <th>No.</th><th>Part Number</th><th>REV</th><th>Approval Status</th><th>Customer</th>
                    <th>Commodity</th><th>Part Pictures</th><th>Packaging Pictures</th><th>Critical</th>
                    <th>CE</th><th>·∫¢nh</th></tr></thead><tbody>`;

                results.slice(0, 10).forEach((item, index) => {
                    const partNumberForId = (item["Part Number"] || `item-${index}`).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, ''); 
                    // *** TH√äM C√ÅC THU·ªòC T√çNH data-* V√ÄO TR ***
                    html += `<tr 
                                data-part-number="${item["Part Number"] || ""}" 
                                data-status="${item["Approval Status"] || ""}" 
                                data-part-pic="${item["Part Pictures"] || ""}" 
                                data-pack-pic="${item["Packaging Pictures"] || ""}">
                        <td>${index + 1}</td>
                        <td>${item["Part Number"] || ""}</td>
                        <td>${item["REV"] || ""}</td>
                        <td>${item["Approval Status"] || ""}</td>
                        <td>${item["Customer"] || ""}</td>
                        <td>${item["Commodity"] || ""}</td>
                        <td>${item["Part Pictures"] || ""}</td>
                        <td>${item["Packaging Pictures"] || ""}</td>
                        <td>${item["Critical"] || ""}</td>
                        <td>${item["CE"] || ""}</td>
                        <td id="imageCell-${partNumberForId}-${index}"></td>
                    </tr>`;
                });

                html += `</tbody></table>`;
                relatedResultsDiv.innerHTML = html;
                makeTableSortable('resultsTable');

                results.slice(0, 10).forEach((item, index) => {
                    const erpCode = item["ERP-CODE"]?.toUpperCase() || "";
                    const partNumberForId = (item["Part Number"] || `item-${index}`).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                    const imageCell = document.getElementById(`imageCell-${partNumberForId}-${index}`);
                    if (imageCell) {
                        renderImageCell(erpCode, imageCell);
                    }
                });
            }
        }

        // --- Qu·∫£n l√Ω l·ªãch s·ª≠ t√¨m ki·∫øm ---
        function saveToHistory(partNumber) {
            const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
            const now = new Date().toLocaleString("vi-VN");
            if (history.length > 0 && history[0].partNumber === partNumber) {
                return;
            }
            history.unshift({ partNumber, time: now });
            if (history.length > 20) history.pop();
            localStorage.setItem("searchHistory", JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
            historyList.innerHTML = "";
            history.forEach(item => {
                const li = document.createElement("li");
                li.style.marginBottom = "6px";
                li.innerHTML = `
                <button onclick="processTranscript('${item.partNumber.replace(/'/g, "\\'")}', true); navigator.clipboard.writeText('${item.partNumber.replace(/'/g, "\\'")}')" 
                    title="Click ƒë·ªÉ tra c·ª©u v√† sao ch√©p" 
                    style="background:#444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">
                    ${item.partNumber}</button> <small style="color:#ccc">(${item.time})</small>`;
                historyList.appendChild(li);
            });
        }

        function clearHistory() {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?")) {
                localStorage.removeItem("searchHistory");
                renderHistory();
            }
        }

        // --- X·ª≠ l√Ω s·ª± ki·ªán nh·∫≠n di·ªán gi·ªçng n√≥i ---
        function startRecognition() {
            if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
                statusDiv.style.display = 'block';
                statusDiv.innerText = "‚ùå Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i. Vui l√≤ng s·ª≠ d·ª•ng Google Chrome ho·∫∑c tr√¨nh duy·ªát kh√°c c√≥ h·ªó tr·ª£.";
                speak("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i.");
                recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
                return;
            }

            if (recognition) {
                recognition.stop(); 
            }

            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = "vi-VN";
            recognition.interimResults = true;
            finalTranscriptReceived = false; 

            recognition.onstart = () => {
                isListening = true;
                recordBtn.innerText = "üõë Nh·∫•n ƒë·ªÉ d·ª´ng";
                statusDiv.style.display = 'block';
                statusDiv.innerText = "üéß ƒêang nghe...";
                resultDiv.innerHTML = "";
                relatedResultsDiv.innerHTML = "";
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        finalTranscriptReceived = true; 
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${finalTranscript || interimTranscript}</b>`;
                if (finalTranscript) {
                    processTranscript(finalTranscript); 
                }
            };

            recognition.onerror = (e) => {
                statusDiv.style.display = 'block';
                statusDiv.innerText = `‚ùå L·ªói: ${e.error}. Vui l√≤ng th·ª≠ l·∫°i.`;
                speak("ƒê√£ x·∫£y ra l·ªói nh·∫≠n di·ªán gi·ªçng n√≥i.");
                recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
                isListening = false;
            };

            recognition.onend = () => {
                isListening = false;
                recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
                if (!finalTranscriptReceived) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerText = "Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                    resultDiv.innerHTML = ""; 
                } else {
                    if (statusDiv.innerText.includes("ƒêang nghe...")) { 
                       statusDiv.innerText = "";
                       statusDiv.style.display = 'none';
                    }
                }
            };

            recognition.start();
        }

        function stopRecognition() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
            }
        }

        // --- X·ª≠ l√Ω s·ª± ki·ªán click DOM ---
        recordBtn.onclick = () => {
            if (!isListening) {
                startRecognition();
            } else {
                stopRecognition();
            }
        };

        searchBtn.onclick = () => {
            const val = searchInput.value;
            if (val.trim() !== '') {
                processTranscript(val, false);
            } else {
                resultDiv.innerHTML = "Vui l√≤ng nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm.";
                relatedResultsDiv.innerHTML = "";
                statusDiv.style.display = 'none'; 
            }
        };
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                searchBtn.click(); 
            }
        });

        btnImage.onclick = () => {
            analysisMode = 'image';
            updateModeButtons();
        };

        btnStatus.onclick = () => {
            analysisMode = 'status';
            updateModeButtons();
        };

        btnText.onclick = () => {
            inputMode = 'text';
            updateModeButtons();
        };

        btnVoice.onclick = () => {
            inputMode = 'voice';
            updateModeButtons();
        };

        // *** H√ÄM ƒê√É C·∫¨P NH·∫¨T ***
        // X·ª≠ l√Ω click v√†o h√†ng (Highlight + ƒê·ªçc k·∫øt qu·∫£)
        document.addEventListener('click', function(e) {
            const targetRow = e.target.closest('tr'); // T√¨m h√†ng g·∫ßn nh·∫•t ƒë∆∞·ª£c click

            // Ch·ªâ x·ª≠ l√Ω n·∫øu click b√™n trong tbody c·ªßa b·∫£ng k·∫øt qu·∫£
            if (targetRow && targetRow.closest('#resultsTable') && targetRow.parentNode.tagName === 'TBODY') {
                
                // B·ªè highlight t·∫•t c·∫£ c√°c h√†ng
                const rows = document.querySelectorAll('table tbody tr');
                rows.forEach(r => r.classList.remove('active-row'));
                
                // Highlight h√†ng ƒë∆∞·ª£c click
                targetRow.classList.add('active-row');

                // Ki·ªÉm tra xem c√≥ ph·∫£i click v√†o ·∫£nh kh√¥ng
                if (!e.target.classList.contains('thumbnail-image')) {
                    // N·∫øu kh√¥ng ph·∫£i click v√†o ·∫£nh -> ƒê·ªçc k·∫øt qu·∫£
                    const itemData = {
                        "Approval Status": targetRow.dataset.status,
                        "Part Pictures": targetRow.dataset.partPic,
                        "Packaging Pictures": targetRow.dataset.packPic
                    };
                    
                    const msg = analyzePart(itemData); // T√≠nh to√°n l·∫°i k·∫øt qu·∫£
                    speak(msg); // ƒê·ªçc k·∫øt qu·∫£
                }
            }
        });

        // ƒê√≥ng modal khi click v√†o n√∫t X ho·∫∑c b√™n ngo√†i ·∫£nh
        modalCloseBtn.onclick = function() { 
            imageModal.style.display = "none";
        }
        imageModal.onclick = function(e) {
            if (e.target === imageModal) {
                imageModal.style.display = "none";
            }
        }

        // --- Kh·ªüi t·∫°o khi t·∫£i trang ---
        window.onload = () => {
            updateModeButtons(); 
            renderHistory(); 
        };
    </script>
</body>
</html>
